<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GymTracker - Pianificazione Calendario</title>
  <base href="/gymtracker/">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='8' y='12' width='48' height='44' rx='6' ry='6' fill='%23ffffff' stroke='%23667eea' stroke-width='4'/%3E%3Crect x='8' y='20' width='48' height='8' fill='%23667eea'/%3E%3Ccircle cx='20' cy='36' r='3' fill='%23667eea'/%3E%3Ccircle cx='32' cy='36' r='3' fill='%23667eea'/%3E%3Ccircle cx='44' cy='36' r='3' fill='%23667eea'/%3E%3Ccircle cx='20' cy='48' r='3' fill='%23667eea'/%3E%3Ccircle cx='32' cy='48' r='3' fill='%23667eea'/%3E%3Ccircle cx='44' cy='48' r='3' fill='%23667eea'/%3E%3C/svg%3E">
  <link rel="stylesheet" href="shared/css/shared.css">
  <link rel="stylesheet" href="trainer/css/trainer.css">
  <style>
    /* Grid now provided by shared.css as .page-grid; keep page-specific styles here */
    .sidebar { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 16px; padding: 0; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04); overflow: hidden; min-height: 500px; }
    .calendar-wrap { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04); }
    .sidebar .empty { color: #64748b; text-align: center; padding: 16px; }
    .session-item { border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px; margin-bottom: 8px; background:#f8fafc; cursor: grab; }
    .session-item:active { cursor: grabbing; }
    .exercise-item { padding: 4px 8px; border-left: 3px solid #e2e8f0; margin: 4px 0; color: #334155; font-size: 13px; }
    .calendar-toolbar { display:flex; justify-content: space-between; align-items:center; gap: 8px; margin-bottom: 8px; }
    .calendar-nav { display:flex; gap: 8px; align-items:center; }
    .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .day-header { text-align:center; font-weight:600; color:#475569; padding: 6px 0; }
    .day-cell.other-month { background: #fafafa; color:#94a3b8; }
    .day-cell.today { outline: 2px solid #6366f1; }
    .day-cell.selected { box-shadow: inset 0 0 0 2px #0ea5e9; }
    .day-number { position:absolute; top:6px; right:8px; font-size: 12px; color:#64748b; }
    .day-events { display: flex; flex-direction: column; gap: 2px; margin-top: 16px; flex: 1; }
    .event-pill { background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; padding: 3px 6px; border-radius: 999px; font-size: 12px; display:inline-flex; align-items:center; gap:6px; }
    .event-pill .del { cursor:pointer; color:#ef4444; }
    .day-cell.drag-over { box-shadow: inset 0 0 0 2px #10b981; }
    .controls { display:flex; gap: 8px; align-items:center; }
    .filter-select { width: 100%; }

    /* Stili moderni per la sezione clienti */
    .client-selector-panel {
      width: 320px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
      overflow: visible; /* evita clipping di menu a tendina */
      min-height: 500px;
      position: relative; /* crea stacking context per z-index */
      z-index: 10; /* sopra al calendario a destra */
    }

    .panel-header {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #374151;
      padding: 20px;
      border-bottom: 3px solid #10b981;
    }

    .panel-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .panel-icon {
      font-size: 1.5rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .panel-title h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }


    .client-selection-section {
      padding: 24px;
      border-bottom: 1px solid #f1f5f9;
    }

    /* modern-select, primary-select, label-text moved to shared.css */

    .active-plan-section {
      padding: 24px;
      background: linear-gradient(135deg, #fefefe 0%, #f9fafb 100%);
      flex: 1;
    }

    .plan-header {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 12px 16px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 8px 8px 0 0;
      margin-bottom: 12px;
    }

    .plan-icon {
      font-size: 1.2rem;
    }

    .plan-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
    }

    /* Sezione calendario migliorata */
    .calendar-section {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    .calendar-header {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 16px 20px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .calendar-icon {
      font-size: 1.3rem;
    }

    .calendar-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #374151;
    }

    .calendar-content {
      padding: 16px;
    }

    .calendar-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .calendar-month {
      min-width: 180px;
      text-align: center;
      font-weight: 600;
      color: #374151;
      font-size: 1.1rem;
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .day-header {
      text-align: center;
      font-weight: 600;
      color: #475569;
      padding: 8px 0;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      border-radius: 6px;
    }

    .day-cell {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      min-height: 90px;
      padding: 8px;
      position: relative;
      background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .day-cell:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-color: #cbd5e1;
    }

    .day-cell.other-month {
      background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
      color: #94a3b8;
    }

    .day-cell.today {
      outline: 2px solid #10b981;
      background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
    }

    .day-cell.selected {
      box-shadow: inset 0 0 0 2px #0ea5e9;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }

    .day-cell.drag-over {
      box-shadow: inset 0 0 0 2px #10b981;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      transform: scale(1.02);
    }

    .event-pill {
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      color: #3730a3;
      border: 1px solid #c7d2fe;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      transition: all 0.2s ease;
      cursor: grab;
      width: 100%;
      min-height: 22px;
      flex: 1;
    }

    .event-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }

    .event-pill.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .event-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }

    .event-pill .del {
      cursor: pointer;
      color: #ef4444;
      transition: color 0.2s ease;
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 12px;
    }

    .event-pill .del:hover {
      color: #dc2626;
      background: rgba(239, 68, 68, 0.1);
    }

    /* Context Menu Styles */
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 8px 0;
      z-index: 1000;
      min-width: 200px;
      max-width: 300px;
      display: none;
    }

    .context-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      border-bottom: 1px solid #f1f5f9;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .context-menu-item:last-child {
      border-bottom: none;
    }

    .context-menu-item:hover {
      background-color: #f8fafc;
    }

    .context-menu-item.cancel {
      color: #ef4444;
      border-top: 1px solid #f1f5f9;
      margin-top: 4px;
    }

    .context-menu-item.cancel:hover {
      background-color: #fef2f2;
    }

    .context-menu-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    /* Miglioramento controlli */
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    /* delete button now uses shared .btn-delete (semantico) */

    .controls input[type="number"] {
      width: 70px;
      padding: 6px 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.2s ease;
    }

    .controls input[type="number"]:focus {
      outline: none;
      border-color: #10b981;
    }

    .controls label {
      font-size: 12px;
      color: #64748b;
      font-weight: 500;
    }

    /* Miglioramento sessioni drag & drop */
    .session-item {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      cursor: grab;
      transition: all 0.3s ease;
      position: relative;
    }

    .session-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-color: #cbd5e1;
    }

    .session-item:active {
      cursor: grabbing;
    }

    .session-item.dragging {
      opacity: 0.7;
      transform: rotate(2deg);
    }

    .exercise-item {
      padding: 6px 12px;
      border-left: 3px solid #10b981;
      margin: 6px 0;
      color: #334155;
      font-size: 13px;
      background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
      border-radius: 4px;
    }

    .empty {
      color: #64748b;
      text-align: center;
      padding: 20px;
      font-style: italic;
    }

    /* Miglioramento responsiveness */
    @media (max-width: 768px) {
      .layout {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .client-selector-panel {
        width: 100%;
        min-height: auto;
      }
      
      .calendar-toolbar {
        flex-direction: column;
        gap: 12px;
      }
      
      .calendar-nav {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .controls {
        flex-wrap: wrap;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div data-include="shared/partials/header.html"></div>
  <main class="trainer-dashboard">
    <div class="dashboard-header">
      <h1>📅 Pianificazione Calendario</h1>
      <div class="trainer-actions">
      </div>
    </div>

    <div class="page-grid">
      <aside class="client-selector-panel">
        <!-- Header della sezione clienti -->
        <div class="panel-header">
          <div class="panel-title">
            <span class="panel-icon">👥</span>
            <h3>Gestione Clienti</h3>
          </div>
          <select id="filterActive" class="modern-select" onchange="loadClients()">
            <option value="all">Tutti i clienti</option>
            <option value="true" selected>Solo attivi</option>
            <option value="false">Solo disattivati</option>
          </select>
        </div>

        <!-- Selezione cliente -->
        <div class="client-selection-section">
          <label class="modern-label">
            <span class="label-text">Cliente selezionato</span>
            <select id="clientSelect" class="modern-select primary-select" onchange="onClientChange()">
              <option value="">-- Seleziona un cliente --</option>
            </select>
          </label>
        </div>

        <!-- Scheda attiva -->
        <div class="active-plan-section">
          <div class="plan-header">
            <span class="plan-icon">📋</span>
            <h3>Scheda Attiva</h3>
          </div>
          <div id="activePlanBox">
            <div class="empty">Seleziona un cliente per vedere la scheda attiva</div>
          </div>
        </div>
      </aside>

      <section class="calendar-section">
        <div class="calendar-header">
          <span class="calendar-icon">📅</span>
          <h3>Calendario Pianificazione</h3>
        </div>
        
        <div class="calendar-content">
          <div class="calendar-toolbar">
            <div class="calendar-nav">
              <button class="btn btn-blue" title="Mese precedente" aria-label="Mese precedente" onclick="changeMonth(-1)">◀</button>
              <div id="currentMonth" class="calendar-month">Caricamento...</div>
              <button class="btn btn-blue" title="Mese successivo" aria-label="Mese successivo" onclick="changeMonth(1)">▶</button>
              <button class="btn btn-blue" title="Vai a oggi" onclick="goToToday()">Oggi</button>
            </div>
            <div class="controls">
              <label for="weeksInput">Estendi settimana:</label>
              <input id="weeksInput" type="number" min="1" max="52" value="1">
              <button class="btn btn-add" onclick="extendCurrentWeek()">Estendi</button>
              <button class="btn btn-delete" title="Elimina tutte le occorrenze dalla data selezionata in avanti" onclick="deleteFromSelected()">Elimina da data</button>
            </div>
          </div>

          <div class="month-grid" id="calendarGrid"></div>
        </div>
      </section>
    </div>
  </main>

  <script src="shared/js/core/api.js"></script>
  <script src="shared/js/include.js"></script>
  <script src="shared/js/core/utils.js"></script>
  <script>
    // Auth + role check (trainer/admin)
    async function checkTrainerAccess() {
      const token = GymAPI.getToken();
      if (!token) {
        window.location.href = '/gymtracker/utente/';
        return false;
      }
      try {
        const me = await GymAPI.get('/users/me');
        const role = (me?.profile?.user_type || me?.user_type || '').toString().toLowerCase();
        if (role !== 'admin') {
          alert('Accesso riservato ai trainer');
          window.location.href = '/gymtracker/utente/dashboard.html';
          return false;
        }
        return true;
      } catch (e) {
        GymAPI.removeToken();
        window.location.href = '/gymtracker/utente/';
        return false;
      }
    }

    const monthNames = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
    let currentDate = new Date();
    let selectedClient = null; // { id, ... }
    let currentPlan = null; // { id, durata_settimane, ... }
    let planSessions = []; // sessions array
    let planExercises = {}; // sessionId -> [exercises]
    let scheduledItems = []; // items from backend for visible range
    let draggedSessionId = null; let draggedEventId = null;
    let selectedDate = null; // used for highlighting and week extension
    let contextMenu = null;
    let contextMenuTarget = null;
    let longPressTimer = null;
    let longPressStarted = false;

    // Clients loading
    async function loadClients() {
      const active = document.getElementById('filterActive').value;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/clients?active=${active}`, { headers: { Authorization: 'Bearer ' + t }});
      const data = await r.json();
      const clients = data.clients || [];
      const sel = document.getElementById('clientSelect');
      const prev = sel.value;
      sel.innerHTML = '<option value="">-- Seleziona un cliente --</option>';
      clients.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.full_name ? `${c.full_name} (${c.email})` : (c.email || 'Senza nome');
        sel.appendChild(opt);
      });
      const q = new URLSearchParams(window.location.search);
      const qUser = q.get('user_id');
      if (qUser && clients.some(c => c.id === qUser)) sel.value = qUser;
      else if (prev && clients.some(c => c.id === prev)) sel.value = prev;
      else if (!sel.value && clients.length) sel.value = clients[0].id;
      if (sel.value) onClientChange();
    }

    async function onClientChange() {
      const id = document.getElementById('clientSelect').value;
      if (!id) {
        selectedClient = null;
        document.getElementById('activePlanBox').innerHTML = '<div class="empty">Seleziona un cliente per vedere la scheda attiva</div>';
        renderCalendar();
        return;
      }
      selectedClient = { id };
      await loadActivePlanAndSessions();
      await loadScheduleForMonth();
      renderCalendar();
    }

    async function loadActivePlanAndSessions() {
      currentPlan = null; planSessions = []; planExercises = {};
      const box = document.getElementById('activePlanBox');
      box.innerHTML = '<div class="empty">Caricamento scheda attiva...</div>';
      try {
        const t = GymAPI.getToken();
        const url = `${GymAPI.baseURL}/trainer/active-plan?user_id=${encodeURIComponent(selectedClient.id)}`;
        const r = await fetch(url, { headers: { Authorization: 'Bearer ' + t }});
        if (r.status === 404) {
          box.innerHTML = '<div class="empty">Nessuna scheda attiva</div>';
          return;
        }
        const { plan, sessions } = await r.json();
        currentPlan = plan;
        planSessions = sessions || [];
        // Render sessions + nested exercises (simplified: show count badge; we can fetch details via /plans/:id if needed)
        await renderActivePlanBox();
        // Suggest weeks input from plan
        const w = document.getElementById('weeksInput');
        if (plan?.durata_settimane) w.value = plan.durata_settimane;
      } catch (e) {
        box.innerHTML = '<div class="empty">Errore nel caricamento della scheda</div>';
      }
    }

    async function renderActivePlanBox() {
      const box = document.getElementById('activePlanBox');
      if (!currentPlan) { box.innerHTML = '<div class="empty">Nessuna scheda attiva</div>'; return; }
      // For detailed exercises, fetch /plans/:id once
      try {
        const t = GymAPI.getToken();
        const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(currentPlan.id)}`, { headers: { Authorization: 'Bearer ' + t }});
        const { sessions, exercises } = await r.json();
        planSessions = sessions || [];
        planExercises = {};
        (exercises || []).forEach(ex => {
          (planExercises[ex.sessione_id] ||= []).push(ex);
        });
      } catch {}

      let html = '';
      html += `<div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden;">`;
      html += `<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 12px 16px; border-bottom: 2px solid #e2e8f0;">`;
      html += `<h4 style="margin: 0; color: #374151;">${Utils.escapeHtml(currentPlan.titolo || 'Scheda attiva')}</h4>`;
      html += `</div><div style="padding: 16px;">`;
      
      if (!planSessions.length) {
        html += '<div class="empty">La scheda non ha sessioni</div>';
      } else {
        html += planSessions.map(s => {
          const exs = planExercises[s.id] || [];
          return `
            <div class="session-item" draggable="true" data-session-id="${s.id}">
              <div style="font-weight:600; color: #374151;">${Utils.escapeHtml(s.nome || 'Sessione')}</div>
              <div style="font-size:12px; color:#64748b; margin-bottom: 8px;">${exs.length} esercizi</div>
              ${exs.length ? exs.map(e => `<div class=\"exercise-item\">• ${Utils.escapeHtml(e.name || '')}${e.sets_count?` — ${e.sets_count}x${e.reps_min||''}-${e.reps_max||''}`:''}</div>`).join('') : ''}
            </div>`;
        }).join('');
      }
      html += `</div></div>`;
      box.innerHTML = html;

      // Enable dual functionality: drag-and-drop from sidebar + context menu
      box.querySelectorAll('.session-item').forEach(el => {
        el.addEventListener('dragstart', (e) => {
          draggedSessionId = el.dataset.sessionId;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          try { e.dataTransfer.setData('text/plain', draggedSessionId); } catch {}
        });
        el.addEventListener('dragend', () => el.classList.remove('dragging'));
      });
    }

    // Calendar rendering
    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      // Calcola il lunedì della settimana che contiene il primo giorno del mese
      const dayOfWeek = firstDay.getDay(); // 0=Dom, 1=Lun, ..., 6=Sab
      const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Per iniziare da lunedì
      startDate.setDate(startDate.getDate() - daysFromMonday);
      const days = [];
      for (let i = 0; i < 42; i++) { // 6 weeks
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i);
        days.push(d);
      }

      let html = '';
      ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'].forEach(d => {
        html += `<div class="day-header">${d}</div>`;
      });
      const today = new Date();
      days.forEach(d => {
        const dateStr = d.toISOString().slice(0,10);
        const isOther = d.getMonth() !== month;
        const isToday = d.toDateString() === today.toDateString();
        const isSelected = selectedDate && (new Date(selectedDate).toDateString() === d.toDateString());
        const items = scheduledItems.filter(it => it.date === dateStr);
        html += `
          <div class="day-cell ${isOther?'other-month':''} ${isToday?'today':''} ${isSelected?'selected':''}" data-date="${dateStr}">
            <div class="day-number">${d.getDate()}</div>
            <div class="day-events">
              ${items.map(it => `<span class=\"event-pill\" data-item-id=\"${it.id}\" draggable=\"true\"><span class=\"event-text\">${Utils.escapeHtml(it.sessioni?.nome || it.session_name || 'Sessione')}</span><span class=\"del\" title=\"Elimina\" data-del-id=\"${it.id}\">✕</span></span>`).join('')}
            </div>
          </div>`;
      });
      grid.innerHTML = html;

      // Bind events on cells
      grid.querySelectorAll('.day-cell').forEach(cell => {
        // selection
        cell.addEventListener('click', (e) => {
          // Don't select if context menu is open
          if (contextMenu && contextMenu.style.display !== 'none') {
            hideContextMenu();
            return;
          }
          selectedDate = new Date(cell.dataset.date);
          grid.querySelectorAll('.day-cell.selected').forEach(c => c.classList.remove('selected'));
          cell.classList.add('selected');
        });

        // Right-click context menu
        cell.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (!selectedClient || !planSessions.length) return;
          if (cell.classList.contains('other-month')) return;
          
          showContextMenu(e.pageX, e.pageY, cell.dataset.date);
        });

        // Mobile long-press support
        cell.addEventListener('touchstart', (e) => {
          if (!selectedClient || !planSessions.length) return;
          if (cell.classList.contains('other-month')) return;
          
          longPressStarted = true;
          longPressTimer = setTimeout(() => {
            if (longPressStarted) {
              e.preventDefault();
              const touch = e.touches[0];
              showContextMenu(touch.pageX, touch.pageY, cell.dataset.date);
            }
          }, 600); // 600ms long press
        });

        cell.addEventListener('touchmove', () => {
          longPressStarted = false;
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        });

        cell.addEventListener('touchend', () => {
          longPressStarted = false;
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        });
        // Keep drag-and-drop for both sessions and existing events
        cell.addEventListener('dragover', (e) => {
          if (!selectedClient) return; // need a client
          if (!draggedEventId && !draggedSessionId) return; // need something to drop
          e.preventDefault();
          cell.classList.add('drag-over');
        });
        cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
        cell.addEventListener('drop', async (e) => {
          e.preventDefault();
          cell.classList.remove('drag-over');
          const sessionId = draggedSessionId || (e.dataTransfer && e.dataTransfer.getData('text/plain'));
          const eventId = draggedEventId;
          draggedSessionId = null;
          draggedEventId = null;
          
          if (!selectedClient) return;
          if (cell.classList.contains('other-month')) return;
          
          if (eventId) {
            // Moving existing event
            await moveScheduledItem(eventId, cell.dataset.date);
          } else if (sessionId) {
            // Creating new event from sidebar
            await createScheduledItem(sessionId, cell.dataset.date);
          }
        });
      });

      // Bind delete click
      grid.querySelectorAll('.event-pill .del').forEach(del => {
        del.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = del.getAttribute('data-del-id');
          if (!confirm('Eliminare questa pianificazione?')) return;
          await deleteScheduledItem(id);
        });
      });

      // Bind drag events for existing events
      grid.querySelectorAll('.event-pill').forEach(pill => {
        pill.addEventListener('dragstart', (e) => {
          e.stopPropagation();
          pill.classList.add('dragging');
          draggedEventId = pill.getAttribute('data-item-id');
          e.dataTransfer.setData('text/plain', draggedEventId);
        });
        
        pill.addEventListener('dragend', (e) => {
          e.stopPropagation();
          pill.classList.remove('dragging');
          draggedEventId = null;
        });
      });
    }

    async function loadScheduleForMonth() {
      scheduledItems = [];
      if (!selectedClient) return;
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const start = firstDay.toISOString().slice(0,10);
      const end = lastDay.toISOString().slice(0,10);
      try {
        const t = GymAPI.getToken();
        const url = `${GymAPI.baseURL}/trainer/schedule?user_id=${encodeURIComponent(selectedClient.id)}&start=${start}&end=${end}`;
        console.log('[Calendario] GET schedule', { url });
        const r = await fetch(url, { headers: { Authorization: 'Bearer ' + t }});
        const data = await r.json();
        scheduledItems = data.items || [];
        console.log('[Calendario] Loaded items', scheduledItems.length);
      } catch (e) {
        console.error('[Calendario] loadScheduleForMonth error', e);
        scheduledItems = [];
      }
    }

    async function createScheduledItem(sessione_id, date) {
      try {
        const t = GymAPI.getToken();
        console.log('[Calendario] POST schedule', { user_id: selectedClient.id, sessione_id, date });
        const r = await fetch(`${GymAPI.baseURL}/trainer/schedule`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', Authorization:'Bearer ' + t },
          body: JSON.stringify({ user_id: selectedClient.id, sessione_id, date })
        });
        if (!r.ok) {
          const err = await r.text().catch(()=> '');
          console.error('[Calendario] createScheduledItem failed', err);
          alert('Errore salvataggio: ' + err);
          return;
        }
        const res = await r.json().catch(()=>({}));
        console.log('[Calendario] Created', res);
        await loadScheduleForMonth();
        renderCalendar();
      } catch (e) {
        console.error('[Calendario] createScheduledItem network error', e);
        alert('Errore di rete nella creazione');
      }
    }

    async function moveScheduledItem(itemId, newDate) {
      try {
        const t = GymAPI.getToken();
        console.log('[Calendario] PUT schedule move', { itemId, newDate });
        const r = await fetch(`${GymAPI.baseURL}/trainer/schedule/${encodeURIComponent(itemId)}`, {
          method: 'PUT',
          headers: { 'Content-Type':'application/json', Authorization:'Bearer ' + t },
          body: JSON.stringify({ date: newDate })
        });
        if (!r.ok) {
          const err = await r.text().catch(()=> '');
          console.error('[Calendario] moveScheduledItem failed', err);
          alert('Errore spostamento: ' + err);
          return;
        }
        console.log('[Calendario] Item moved successfully');
        await loadScheduleForMonth();
        renderCalendar();
      } catch (e) {
        console.error('[Calendario] moveScheduledItem network error', e);
        alert('Errore di rete nello spostamento');
      }
    }

    async function deleteScheduledItem(id) {
      try {
        const t = GymAPI.getToken();
        const r = await fetch(`${GymAPI.baseURL}/trainer/schedule/${encodeURIComponent(id)}`, {
          method: 'DELETE', headers: { Authorization: 'Bearer ' + t }
        });
        if (!r.ok) { alert('Eliminazione fallita'); return; }
        console.log('[Calendario] Deleted id', id);
        scheduledItems = scheduledItems.filter(x => x.id !== id);
        renderCalendar();
      } catch (e) { alert('Errore di rete'); }
    }

    async function deleteFromSelected() {
      if (!selectedClient) return alert('Seleziona un cliente');
      if (!selectedDate) return alert('Seleziona una data sul calendario');
      const from = new Date(selectedDate).toISOString().slice(0,10);
      if (!confirm(`Eliminare tutte le pianificazioni dal ${from} in avanti?`)) return;
      try {
        const t = GymAPI.getToken();
        const url = `${GymAPI.baseURL}/trainer/schedule?user_id=${encodeURIComponent(selectedClient.id)}&start=${from}`;
        const r = await fetch(url, { method: 'DELETE', headers: { Authorization: 'Bearer ' + t }});
        if (!r.ok) { const d = await r.text().catch(()=> ''); return alert('Eliminazione fallita: ' + d); }
        await loadScheduleForMonth();
        renderCalendar();
        alert('Pianificazioni eliminate');
      } catch (e) { alert('Errore di rete nell\'eliminazione'); }
    }

    function changeMonth(dir) {
      currentDate.setMonth(currentDate.getMonth() + dir);
      Promise.resolve(loadScheduleForMonth()).then(renderCalendar);
    }

    function goToToday() {
      currentDate = new Date();
      Promise.resolve(loadScheduleForMonth()).then(renderCalendar);
    }

    function mondayOf(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = (day === 0 ? -6 : 1) - day; // Monday as start; if Sunday, go back 6
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    async function extendCurrentWeek() {
      if (!selectedClient) return alert('Seleziona un cliente');
      
      if (!currentPlan) {
        return alert('Il cliente selezionato non ha una scheda attiva da estendere');
      }
      
      const weeksField = document.getElementById('weeksInput');
      let weeks = parseInt(weeksField.value || '0', 10);
      if (!weeks && currentPlan?.durata_settimane) weeks = parseInt(currentPlan.durata_settimane, 10);
      if (!weeks || weeks < 1) return alert('Numero settimane non valido');
      
      // Seleziona la settimana: se l'utente ha selezionato un giorno, usa quella settimana; altrimenti usa la prima occorrenza
      const startWeek = selectedDate ? mondayOf(new Date(selectedDate)).toISOString().slice(0,10) : 'first';
      
      console.log('[Calendario] EXTEND', { user_id: selectedClient.id, start_week: startWeek, weeks, currentPlan: currentPlan?.titolo });
      
      try {
        const t = GymAPI.getToken();
        console.log('[Calendario] Making API call to:', `${GymAPI.baseURL}/trainer/schedule/extend`);
        
        const r = await fetch(`${GymAPI.baseURL}/trainer/schedule/extend`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', Authorization:'Bearer ' + t },
          body: JSON.stringify({ user_id: selectedClient.id, start_week: startWeek, weeks })
        });
        
        console.log('[Calendario] API response status:', r.status, r.statusText);
        
        const data = await r.json().catch(()=> ({}));
        console.log('[Calendario] API response data:', data);
        
        if (!r.ok) { 
          console.error('[Calendario] extend failed', data); 
          return alert('Estensione fallita: ' + (data.error || `Errore HTTP ${r.status}`)); 
        }
        
        await loadScheduleForMonth();
        renderCalendar();
        
        const inserted = data.inserted || 0;
        if (inserted === 0) {
          alert('Estensione completata, ma nessun nuovo elemento è stato inserito. Possibili cause:\n- La settimana selezionata è già pianificata\n- Non ci sono sessioni da duplicare nella scheda');
        } else {
          alert(`Estensione completata: inseriti ${inserted} nuovi elementi nel calendario`);
        }
      } catch (e) {
        console.error('[Calendario] extend network error', e);
        alert('Errore rete in estensione');
      }
    }

    // Context Menu Functions
    function createContextMenu() {
      if (contextMenu) return;
      
      contextMenu = document.createElement('div');
      contextMenu.className = 'context-menu';
      contextMenu.id = 'sessionContextMenu';
      document.body.appendChild(contextMenu);
      
      // Hide menu when clicking outside
      document.addEventListener('click', (e) => {
        if (contextMenu && !contextMenu.contains(e.target)) {
          hideContextMenu();
        }
      });
      
      // Hide menu on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideContextMenu();
        }
      });
    }

    function showContextMenu(x, y, targetDate) {
      if (!contextMenu) createContextMenu();
      
      contextMenuTarget = targetDate;
      
      // Build menu content
      let html = '';
      
      // Add available sessions
      planSessions.forEach(session => {
        html += `
          <div class="context-menu-item" data-session-id="${session.id}">
            <span class="context-menu-icon">🏋️</span>
            <span>${Utils.escapeHtml(session.nome || 'Sessione')}</span>
          </div>`;
      });
      
      // Add cancel option
      html += `
        <div class="context-menu-item cancel">
          <span class="context-menu-icon">❌</span>
          <span>Annulla</span>
        </div>`;
      
      contextMenu.innerHTML = html;
      
      // Position menu
      contextMenu.style.display = 'block';
      contextMenu.style.left = x + 'px';
      contextMenu.style.top = y + 'px';
      
      // Ensure menu stays within viewport
      const rect = contextMenu.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      if (rect.right > viewportWidth) {
        contextMenu.style.left = (x - rect.width) + 'px';
      }
      if (rect.bottom > viewportHeight) {
        contextMenu.style.top = (y - rect.height) + 'px';
      }
      
      // Bind click events
      contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.stopPropagation();
          
          const sessionId = item.getAttribute('data-session-id');
          if (sessionId) {
            // Insert session into selected date
            await createScheduledItem(sessionId, contextMenuTarget);
          }
          
          hideContextMenu();
        });
      });
    }

    function hideContextMenu() {
      if (contextMenu) {
        contextMenu.style.display = 'none';
        contextMenuTarget = null;
      }
    }

    function logout() {
      const confirmLogout = confirm('Sei sicuro di voler uscire?');
      if (confirmLogout) GymAPI.logout();
    }

    // Init page
    (async function init() {
      if (!await checkTrainerAccess()) return;
      await loadClients();
      await loadScheduleForMonth();
      renderCalendar();
    })();
  </script>
</body>
</html>
