<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GymTracker - Gestione Schede</title>
  <base href="/gymtracker/">
  <link rel="stylesheet" href="shared/css/shared.css">
  <link rel="stylesheet" href="trainer/css/trainer.css">
  <style>
    /* Layout moved to shared (.trainer-dashboard + .page-grid) */

    /* Sidebar con design unificato */
    .sidebar { 
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: 16px; 
      padding: 0;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
      overflow: visible; /* evita clipping menu a tendina/tooltip */
      height: fit-content;
      position: relative;
      z-index: 10;
    }

    .sidebar-header {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #374151;
      padding: 20px;
      border-bottom: 3px solid #10b981;
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-content {
      padding: 20px;
    }

    .client-item { 
      padding: 12px 16px;
      border-radius: 10px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      cursor: pointer;
      margin-bottom: 6px;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      background: white;
    }

    .client-item:hover { 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: translateY(-1px);
      border-color: #cbd5e1;
    }

    .client-item.active { 
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-color: #10b981;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }

    .badge { 
      font-size: 10px; 
      padding: 3px 8px; 
      border-radius: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge.active { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .badge.inactive { 
      background: #e2e8f0; 
      color: #64748b; 
    }

    /* Area principale schede */
    .plans { 
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: 20px; 
      padding: 0;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      overflow: hidden;
    }

    .plans-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 24px;
      border-bottom: 3px solid #10b981;
      position: relative;
    }

    .plans-header::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #10b981 100%);
    }

    .plans-content {
      padding: 24px;
    }

    .plan-item { 
      padding: 16px; 
      border-radius: 12px; 
      border: 2px solid #e2e8f0; 
      margin-bottom: 12px; 
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .plan-item:hover {
      border-color: #cbd5e1;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .plan-item.active { 
      background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }

    /* Bottoni: usa shared.css alias semantici (.btn, .btn-add, .btn-save, .btn-cancel, .btn-delete, .btn-sm, .btn-lg, .btn-with-icon) */

    /* INTESTAZIONE SCHEDA CON CAMPI AFFIANCATI */
    .plan-header-section {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      border: 1px solid #e2e8f0;
    }

    .plan-fields-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .field-label {
      font-weight: 600;
      color: #374151;
      min-width: 100px;
      font-size: 14px;
    }

    .field-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    .field-input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      background: #fefffe;
    }

    .field-textarea {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    /* LISTA SESSIONI E ESERCIZI */
    .session-card {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      margin-bottom: 24px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .session-card:hover {
      border-color: #cbd5e1;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .session-header {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
    }

    .session-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .session-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .session-content {
      padding: 24px;
    }

    .exercise-list {
      display: grid;
      gap: 12px;
    }

    .exercise-item {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .exercise-item:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .exercise-info {
      flex: 1;
    }

    .exercise-name {
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }

    .exercise-details {
      font-size: 13px;
      color: #64748b;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .exercise-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .no-exercises {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
      font-style: italic;
    }

    /* POPUP MODERNI */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .popup-overlay.active {
      display: flex;
    }

    .popup-content {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.8);
      animation: popupShow 0.3s ease forwards;
    }

    .popup-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
      padding: 24px;
      position: relative;
    }

    .popup-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #10b981, #34d399, #10b981);
    }

    .popup-title {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .popup-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .popup-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .popup-body {
      padding: 32px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .popup-form {
      display: grid;
      gap: 20px;
    }

    .popup-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .popup-form-full {
      grid-column: 1 / -1;
    }

    .popup-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      display: block;
    }

    .popup-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .popup-input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .popup-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .popup-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      background: white;
    }

    .popup-footer {
      background: #f8fafc;
      padding: 24px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      border-top: 1px solid #e2e8f0;
    }

    /* ANIMAZIONI */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes popupShow {
      from { 
        transform: scale(0.8) translateY(20px);
        opacity: 0;
      }
      to { 
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    /* UTILITY CLASSES */
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .flex {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    @media (max-width: 768px) {
      .plan-fields-grid {
        grid-template-columns: 1fr;
      }
      
      .field-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .field-label {
        min-width: auto;
      }

      .popup-content {
        width: 95%;
        margin: 20px;
      }

      .popup-form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div data-include="shared/partials/header.html"></div>
  
  <main class="trainer-dashboard">
    <div class="dashboard-header">
      <h1>📋 Gestione Schede Allenamento</h1>
      <div class="trainer-actions"></div>
    </div>

    <div class="page-grid">
    <!-- SIDEBAR CLIENTI -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2 style="margin: 0; font-size: 1.2rem;">
          👥 Clienti
        </h2>
      </div>
      <div class="sidebar-content">
        <div id="clientsList">
          <div style="color: #64748b; text-align: center; padding: 20px;">
            Caricamento clienti...
          </div>
        </div>
      </div>
    </div>

    <!-- AREA PRINCIPALE SCHEDE -->
    <div class="plans">
      <div class="plans-header">
        <h2 style="margin: 0; font-size: 1.2rem; color: #374151;">Elenco e Dettaglio Schede</h2>
      </div>
      
      <div class="plans-content">
        <div id="plansList" style="margin-bottom: 20px;"></div>
        <div id="planDetail"></div>
      </div>
    </div>
    </div>
  </main>

  <!-- POPUP NUOVA/MODIFICA SESSIONE -->
  <div class="popup-overlay" id="sessionPopup">
    <div class="popup-content">
      <div class="popup-header">
        <h3 class="popup-title" id="sessionPopupTitle">Nuova Sessione</h3>
        <button class="popup-close" onclick="closePopup('sessionPopup')">&times;</button>
      </div>
      <div class="popup-body">
        <form class="popup-form" id="sessionForm">
          <div class="popup-form-full">
            <label class="popup-label">Nome Sessione</label>
            <input type="text" class="popup-input" id="sessionName" placeholder="es. Push Day, Gambe, Full Body..." required>
          </div>
          <div class="popup-form-full">
            <label class="popup-label">Descrizione (facoltativa)</label>
            <textarea class="popup-textarea" id="sessionDescription" placeholder="Descrizione della sessione..."></textarea>
          </div>
          <div class="popup-form-row">
            <div>
              <label class="popup-label">Giorno Settimana</label>
              <select class="popup-select" id="sessionDay">
                <option value="">Non specificato</option>
                <option value="1">Lunedì</option>
                <option value="2">Martedì</option>
                <option value="3">Mercoledì</option>
                <option value="4">Giovedì</option>
                <option value="5">Venerdì</option>
                <option value="6">Sabato</option>
                <option value="0">Domenica</option>
              </select>
            </div>
            <div>
              <label class="popup-label">Durata Stimata (min)</label>
              <input type="number" class="popup-input" id="sessionDuration" min="15" max="300" placeholder="60">
            </div>
          </div>
        </form>
      </div>
      <div class="popup-footer">
        <button class="btn btn-cancel" onclick="closePopup('sessionPopup')">Annulla</button>
        <button class="btn btn-save" onclick="saveSessionFromPopup()">💾 Salva Sessione</button>
      </div>
    </div>
  </div>

  <!-- POPUP NUOVO/MODIFICA ESERCIZIO -->
  <div class="popup-overlay" id="exercisePopup">
    <div class="popup-content">
      <div class="popup-header">
        <h3 class="popup-title" id="exercisePopupTitle">Nuovo Esercizio</h3>
        <button class="popup-close" onclick="closePopup('exercisePopup')">&times;</button>
      </div>
      <div class="popup-body">
        <form class="popup-form" id="exerciseForm">
          <div class="popup-form-full">
            <label class="popup-label">Nome Esercizio</label>
            <input type="text" class="popup-input" id="exerciseName" placeholder="es. Panca piana, Squat, Trazioni..." required>
          </div>
          <div class="popup-form-row">
            <div>
              <label class="popup-label">Serie</label>
              <input type="number" class="popup-input" id="exerciseSets" min="1" max="20" value="3">
            </div>
            <div>
              <label class="popup-label">Ripetizioni Min</label>
              <input type="number" class="popup-input" id="exerciseRepsMin" min="1" max="100" value="8">
            </div>
          </div>
          <div class="popup-form-row">
            <div>
              <label class="popup-label">Ripetizioni Max</label>
              <input type="number" class="popup-input" id="exerciseRepsMax" min="1" max="100" value="12">
            </div>
            <div>
              <label class="popup-label">Peso Suggerito (kg)</label>
              <input type="number" class="popup-input" id="exerciseWeight" min="0" step="0.5" value="0">
            </div>
          </div>
          <div class="popup-form-row">
            <div>
              <label class="popup-label">Riposo (secondi)</label>
              <input type="number" class="popup-input" id="exerciseRest" min="10" max="600" value="90">
            </div>
            <div>
              <label class="popup-label">Intensità (0-10)</label>
              <input type="number" class="popup-input" id="exerciseIntensity" min="0" max="10" value="0">
            </div>
          </div>
          <div class="popup-form-full">
            <label class="popup-label">Link Video/Tutorial (facoltativo)</label>
            <input type="url" class="popup-input" id="exerciseUrl" placeholder="https://www.youtube.com/watch?v=...">
          </div>
          <div class="popup-form-full">
            <label class="popup-label">Note Trainer (facoltative)</label>
            <textarea class="popup-textarea" id="exerciseNotes" placeholder="Note aggiuntive per l'esercizio..."></textarea>
          </div>
        </form>
      </div>
      <div class="popup-footer">
        <button class="btn btn-cancel" onclick="closePopup('exercisePopup')">Annulla</button>
        <button class="btn btn-save" onclick="saveExerciseFromPopup()">💾 Salva Esercizio</button>
      </div>
    </div>
  </div>

  <div data-include="shared/partials/footer.html"></div>
  <script src="shared/js/core/api.js"></script>
  <script src="shared/js/include.js"></script>
  <script src="shared/js/core/utils.js"></script>
  <script src="shared/js/webhooks.js"></script>
  <script>
    // Auth check
    if (!GymAPI.isAuthenticated()) {
      window.location.href = '/gymtracker/utente/';
    }

    let currentClient = null;
    let currentPlans = [];
    let currentPlan = null;
    let clientsData = [];
    let editingSession = null;  
    let editingExercise = null; 

    // POPUP MANAGEMENT
    function openPopup(popupId) {
      document.getElementById(popupId).classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closePopup(popupId) {
      document.getElementById(popupId).classList.remove('active');
      document.body.style.overflow = '';
      const form = document.querySelector(`#${popupId} form`);
      if (form) form.reset();
      editingSession = null;
      editingExercise = null;
    }

    // GESTIONE CLIENTI
    async function loadClients() {
      try {
        const active = 'all';
        const t = GymAPI.getToken();
        const r = await fetch(`${GymAPI.baseURL}/trainer/clients?active=${active}`, { 
          headers: { Authorization: 'Bearer ' + t }
        });
        const data = await r.json();
        clientsData = data.clients || [];
        
        let html = '';
        if (!clientsData.length) {
          html = '<div style="color: #64748b; text-align: center; padding: 20px;">Nessun cliente trovato</div>';
        } else {
          clientsData.forEach(c => {
            html += `
              <div class="client-item" onclick="selectClient('${c.id}', '${(c.full_name || c.email || 'Cliente').replace(/'/g, '\\\'')}')" id="client_${c.id}">
                <div>
                  <strong>${c.full_name || c.email || 'Cliente'}</strong>
                  ${c.email ? `<div style="color: #64748b; font-size: 12px;">${c.email}</div>` : ''}
                </div>
                <span class="badge ${c.utente_attivo !== false ? 'active' : 'inactive'}">
                  ${c.utente_attivo !== false ? 'Attivo' : 'Inattivo'}
                </span>
              </div>`;
          });
        }
        
        document.getElementById('clientsList').innerHTML = html;
      } catch (error) {
        console.error('Errore caricamento clienti:', error);
      }
    }

    function selectClient(id, name) {
      document.querySelectorAll('.client-item').forEach(el => el.classList.remove('active'));
      const clientEl = document.getElementById(`client_${id}`);
      if (clientEl) clientEl.classList.add('active');
      
      currentClient = { id, name };
      currentPlan = null;
      loadPlans();
    }

    // GESTIONE SCHEDE
    async function loadPlans() {
      if (!currentClient) return;
      
      try {
        const t = GymAPI.getToken();
        const r = await fetch(`${GymAPI.baseURL}/trainer/plans?user_id=${encodeURIComponent(currentClient.id)}`, { 
          headers: { Authorization: 'Bearer ' + t }
        });
        const data = await r.json();
        currentPlans = data.plans || [];
        
        const box = document.getElementById('plansList');
        box.innerHTML = '';
        
        if (!currentPlans.length) {
          box.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #64748b;">
              <p>Nessuna scheda trovata per <strong>${currentClient.name}</strong></p>
          <button class="btn btn-add btn-with-icon" onclick="createPlan()">
            ➕ Crea Prima Scheda
          </button>
            </div>`;
          document.getElementById('planDetail').innerHTML = '';
          return;
        }

        box.innerHTML = `
          <div class="flex-between" style="margin-bottom: 16px;">
            <h3 style="margin: 0; color: #374151;">Schede di <strong>${currentClient.name}</strong></h3>
            <button class="btn btn-add btn-with-icon" onclick="createPlan()">
              ➕ Nuova Scheda
            </button>
          </div>`;

        currentPlans.forEach(p => {
          const d = document.createElement('div');
          d.className = 'plan-item' + (currentPlan && currentPlan.id === p.id ? ' active' : '');
          d.innerHTML = `
            <div class="flex-between">
              <span><strong>${p.titolo || '(Senza titolo)'}</strong></span>
              <div class="flex">
                <span class="badge ${p.attiva !== false ? 'active' : 'inactive'}">
                  ${p.attiva !== false ? 'Attiva' : 'Inattiva'}
                </span>
                <label style="font-size: 12px; color: #64748b; margin-right: 6px; cursor: pointer;">
                  <input type="checkbox" ${p.attiva !== false ? 'checked' : ''} 
                         onclick="event.stopPropagation(); togglePlanActive('${p.id}', this.checked, this)" style="margin-right: 4px;"/> 
                  attiva
                </label>
              </div>
            </div>`;
          d.onclick = () => openPlan(p, d);
          box.appendChild(d);
        });
        
        document.getElementById('planDetail').innerHTML = '';
      } catch (error) {
        console.error('Errore caricamento schede:', error);
      }
    }

    async function openPlan(p, el) {
      currentPlan = p;
      document.querySelectorAll('#plansList .plan-item').forEach(i => i.classList.remove('active'));
      if (el) el.classList.add('active');
      
      try {
        const t = GymAPI.getToken();
        const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(p.id)}`, { 
          headers: { Authorization: 'Bearer ' + t }
        });
        const data = await r.json();
        const { plan, sessions, exercises } = data;
        
        renderPlanDetail(plan, sessions || [], exercises || []);
      } catch (error) {
        console.error('Errore caricamento dettagli scheda:', error);
      }
    }

    function renderPlanDetail(plan, sessions, exercises) {
      const box = document.getElementById('planDetail');
      
      let html = `
        <div style="margin-bottom: 20px;">
          <button class="btn btn-cancel" onclick="loadPlans()">
            ← Torna alle schede
          </button>
          <button class="btn btn-delete btn-with-icon" onclick="deletePlan()" style="float: right;">
            🗑 Elimina scheda
          </button>
        </div>`;

      // INTESTAZIONE SCHEDA
      html += `
        <div class="plan-header-section">
          <h3 style="margin: 0 0 20px 0; color: #374151;">📋 Configurazione Scheda</h3>
          
          <div class="plan-fields-grid">
            <div class="field-row">
              <label class="field-label">Titolo:</label>
              <input class="field-input" id="planTitle" type="text" value="${plan.titolo || ''}" placeholder="Nome della scheda">
            </div>
            
            <div class="field-row">
              <label class="field-label">Autore:</label>
              <input class="field-input" id="planAuthor" type="text" value="${plan.autore || ''}" placeholder="Trainer responsabile">
            </div>
            
            <div class="field-row">
              <label class="field-label">Durata (sett.):</label>
              <input class="field-input" id="planWeeks" type="number" min="1" max="52" value="${plan.durata_settimane || ''}" placeholder="es. 12">
            </div>
            
            <div class="field-row">
              <label class="field-label">Sessioni/sett.:</label>
              <input class="field-input" id="planSpw" type="number" min="1" max="14" value="${plan.sessioni_settimana || ''}" placeholder="es. 3">
            </div>
          </div>
          
          <div class="field-row">
            <label class="field-label">Descrizione:</label>
            <textarea class="field-textarea" id="planDesc" placeholder="Descrizione della scheda...">${plan.descrizione || ''}</textarea>
          </div>
          
          <div style="margin-top: 20px;">
            <button class="btn btn-save btn-lg btn-with-icon" onclick="savePlan('${plan.id}')">
              💾 Salva Configurazione
            </button>
          </div>
        </div>`;

      // SEZIONI SESSIONI
      html += `
        <div class="flex-between" style="margin-bottom: 20px;">
          <h3 style="margin: 0; color: #374151;">🏋️ Sessioni Allenamento</h3>
          <button class="btn btn-add btn-lg btn-with-icon" onclick="openNewSessionPopup()">
            ➕ Nuova Sessione
          </button>
        </div>`;

      if (!sessions.length) {
        html += `
          <div class="no-exercises">
            <span style="font-size: 48px; opacity: 0.3;">🏋️</span>
            <div>Nessuna sessione creata</div>
            <div style="color: #64748b;">Aggiungi la prima sessione per iniziare</div>
          </div>`;
      } else {
        sessions.forEach(s => {
          const sessionExercises = exercises.filter(e => e.sessione_id === s.id);
          
          html += `
            <div class="session-card">
              <div class="session-header">
                <div class="session-title-row">
                  <div>
                    <h4 style="margin: 0; color: #374151;">${s.nome || 'Sessione senza nome'}</h4>
                    ${s.descrizione ? `<p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">${s.descrizione}</p>` : ''}
                  </div>
                  <div class="session-actions">
                    <button class="btn btn-secondary btn-sm" onclick="openEditSessionPopup('${s.id}', '${(s.nome || '').replace(/'/g, '\\\'')}'${s.descrizione ? `, '${s.descrizione.replace(/'/g, '\\\'')}''` : ', null'}${s.giorno_settimana ? `, ${s.giorno_settimana}` : ', null'}${s.durata_stimata_minuti ? `, ${s.durata_stimata_minuti}` : ', null'})">
                      ✏️ Modifica
                    </button>
                    <button class="btn btn-add btn-sm btn-with-icon" onclick="openNewExercisePopup('${s.id}')">
                      ➕ Esercizio
                    </button>
                    <button class="btn btn-delete btn-sm btn-with-icon" onclick="deleteSession('${s.id}')">
                      🗑 Elimina
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="session-content">`;

          if (!sessionExercises.length) {
            html += `
              <div class="no-exercises">
                <span style="font-size: 32px; opacity: 0.3;">💪</span>
                <div>Nessun esercizio in questa sessione</div>
              </div>`;
          } else {
            html += `<div class="exercise-list">`;
            sessionExercises.forEach(ex => {
              html += `
                <div class="exercise-item">
                  <div class="exercise-info">
                    <div class="exercise-name">${ex.name || 'Esercizio senza nome'}</div>
                    <div class="exercise-details">
                      <span>Serie: ${ex.sets_count || 3}</span>
                      <span>Rip: ${ex.reps_min || 8}-${ex.reps_max || 12}</span>
                      <span>Peso: ${ex.weight_suggested || 0}kg</span>
                      <span>Riposo: ${ex.rest_seconds || 90}s</span>
                      <span>Intensità: ${ex.intensity || 0}/10</span>
                      ${ex.external_url ? '<span>🔗 Video</span>' : ''}
                    </div>
                  </div>
                  <div class="exercise-actions">
                    <button class="btn btn-secondary btn-sm" onclick="openEditExercisePopup('${ex.id}')">
                      ✏️ Modifica
                    </button>
                    <button class="btn btn-delete btn-sm btn-with-icon" onclick="deleteExercise('${ex.id}')">
                      🗑
                    </button>
                  </div>
                </div>`;
            });
            html += `</div>`;
          }

          html += `</div></div>`;
        });
      }

      box.innerHTML = html;
    }

    // POPUP SESSIONI
    function openNewSessionPopup() {
      editingSession = null;
      document.getElementById('sessionPopupTitle').textContent = 'Nuova Sessione';
      document.getElementById('sessionForm').reset();
      openPopup('sessionPopup');
    }

    function openEditSessionPopup(sessionId, name, description, day, duration) {
      editingSession = sessionId;
      document.getElementById('sessionPopupTitle').textContent = 'Modifica Sessione';
      document.getElementById('sessionName').value = name || '';
      document.getElementById('sessionDescription').value = description || '';
      document.getElementById('sessionDay').value = day || '';
      document.getElementById('sessionDuration').value = duration || '';
      openPopup('sessionPopup');
    }

    async function saveSessionFromPopup() {
      const name = document.getElementById('sessionName').value.trim();
      if (!name) {
        alert('Il nome della sessione è obbligatorio');
        return;
      }

      const payload = {
        nome: name,
        descrizione: document.getElementById('sessionDescription').value.trim() || null,
        giorno_settimana: document.getElementById('sessionDay').value || null,
        durata_stimata_minuti: document.getElementById('sessionDuration').value ? parseInt(document.getElementById('sessionDuration').value) : null
      };

      try {
        const t = GymAPI.getToken();
        let r;
        
        if (editingSession) {
          r = await fetch(`${GymAPI.baseURL}/trainer/sessions/${encodeURIComponent(editingSession)}`, { 
            method: 'PUT', 
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + t }, 
            body: JSON.stringify(payload) 
          });
        } else {
          payload.scheda_id = currentPlan.id;
          r = await fetch(`${GymAPI.baseURL}/trainer/sessions`, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + t }, 
            body: JSON.stringify(payload) 
          });
        }

        if (!r.ok) throw new Error('Salvataggio fallito');
        
        closePopup('sessionPopup');
        openPlan(currentPlan);
        
      } catch (error) {
        console.error('Errore salvataggio sessione:', error);
        alert('Errore nel salvataggio della sessione');
      }
    }

    // POPUP ESERCIZI
    function openNewExercisePopup(sessionId) {
      editingExercise = { sessionId, isNew: true };
      document.getElementById('exercisePopupTitle').textContent = 'Nuovo Esercizio';
      
      document.getElementById('exerciseForm').reset();
      document.getElementById('exerciseSets').value = '3';
      document.getElementById('exerciseRepsMin').value = '8';
      document.getElementById('exerciseRepsMax').value = '12';
      document.getElementById('exerciseWeight').value = '0';
      document.getElementById('exerciseRest').value = '90';
      document.getElementById('exerciseIntensity').value = '0';
      
      openPopup('exercisePopup');
    }

    async function openEditExercisePopup(exerciseId) {
      try {
        const t = GymAPI.getToken();
        const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(currentPlan.id)}`, { 
          headers: { Authorization: 'Bearer ' + t }
        });
        const data = await r.json();
        const exercise = data.exercises.find(e => e.id === exerciseId);
        
        if (!exercise) {
          alert('Esercizio non trovato');
          return;
        }

        editingExercise = { exerciseId, isNew: false };
        document.getElementById('exercisePopupTitle').textContent = 'Modifica Esercizio';
        
        document.getElementById('exerciseName').value = exercise.name || '';
        document.getElementById('exerciseSets').value = exercise.sets_count || 3;
        document.getElementById('exerciseRepsMin').value = exercise.reps_min || 8;
        document.getElementById('exerciseRepsMax').value = exercise.reps_max || 12;
        document.getElementById('exerciseWeight').value = exercise.weight_suggested || 0;
        document.getElementById('exerciseRest').value = exercise.rest_seconds || 90;
        document.getElementById('exerciseIntensity').value = exercise.intensity || 0;
        document.getElementById('exerciseUrl').value = exercise.external_url || '';
        document.getElementById('exerciseNotes').value = exercise.trainer_notes || '';
        
        openPopup('exercisePopup');
      } catch (error) {
        console.error('Errore caricamento esercizio:', error);
        alert('Errore nel caricamento dell\'esercizio');
      }
    }

    async function saveExerciseFromPopup() {
      const name = document.getElementById('exerciseName').value.trim();
      if (!name) {
        alert('Il nome dell\'esercizio è obbligatorio');
        return;
      }

      const payload = {
        name,
        sets_count: parseInt(document.getElementById('exerciseSets').value || '3'),
        reps_min: parseInt(document.getElementById('exerciseRepsMin').value || '8'),
        reps_max: parseInt(document.getElementById('exerciseRepsMax').value || '12'),
        weight_suggested: parseFloat(document.getElementById('exerciseWeight').value || '0'),
        rest_seconds: parseInt(document.getElementById('exerciseRest').value || '90'),
        intensity: parseInt(document.getElementById('exerciseIntensity').value || '0'),
        trainer_notes: document.getElementById('exerciseNotes').value.trim() || null
      };

      const url = document.getElementById('exerciseUrl').value.trim();
      if (url) {
        payload.external_url = url;
      }

      console.log('Payload inviato:', payload);

      try {
        const t = GymAPI.getToken();
        let r;
        
        if (editingExercise.isNew) {
          const createPayload = {
            sessione_id: editingExercise.sessionId,
            ...payload
          };
          
          r = await fetch(`${GymAPI.baseURL}/trainer/exercises`, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + t }, 
            body: JSON.stringify(createPayload) 
          });
        } else {
          r = await fetch(`${GymAPI.baseURL}/trainer/exercises/${encodeURIComponent(editingExercise.exerciseId)}`, { 
            method: 'PUT', 
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + t }, 
            body: JSON.stringify(payload) 
          });
        }

        if (!r.ok) {
          const errorData = await r.json().catch(() => ({}));
          console.error('Errore server:', r.status, errorData);
          throw new Error('Salvataggio fallito: ' + r.status);
        }
        
        closePopup('exercisePopup');
        openPlan(currentPlan);
        
      } catch (error) {
        console.error('Errore salvataggio esercizio:', error);
        alert('Errore nel salvataggio dell\'esercizio: ' + error.message);
      }
    }

    // FUNZIONI CRUD ORIGINALI
    async function savePlan(id) {
      const payload = {
        titolo: document.getElementById('planTitle').value,
        descrizione: document.getElementById('planDesc').value,
        autore: document.getElementById('planAuthor').value || null,
        durata_settimane: (()=>{ const v=document.getElementById('planWeeks').value; return v===''? null : parseInt(v,10); })(),
        sessioni_settimana: (()=>{ const v=document.getElementById('planSpw').value; return v===''? null : parseInt(v,10); })()
      };
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(id)}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify(payload) });
      if (!r.ok) return alert('Salvataggio scheda fallito');
      await loadPlans();
      const plan = currentPlans.find(p => p.id === id);
      if (plan) openPlan(plan);
    }

    async function togglePlanActive(id, checked, el) {
      try {
        const t = GymAPI.getToken();
        if (checked) {
          const otherActive = (currentPlans || []).some(p => p.id !== id && p.attiva !== false);
          if (otherActive) {
            alert("Disattiva le altre schede prima di selezionarne un'altra.");
            if (el) el.checked = false;
            return;
          }
          const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(id)}`, {
            method: 'PUT', headers: { 'Content-Type':'application/json', Authorization:'Bearer '+t },
            body: JSON.stringify({ attiva: true })
          });
          if (!r.ok) throw new Error('Activate failed');
          
          // Check webhook result and show notification
          const result = await r.json().catch(() => ({}));
          if (result.webhook) {
            if (result.webhook.success) {
              showWebhookNotification('✅ Webhook inviato per evento: event.newscheda', 'success');
            } else {
              showWebhookNotification('❌ Webhook fallito per evento: event.newscheda', 'error');
            }
          }
          
          await loadPlans();
        } else {
          const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(id)}`, {
            method: 'PUT', headers: { 'Content-Type':'application/json', Authorization:'Bearer '+t },
            body: JSON.stringify({ attiva: false })
          });
          if (!r.ok) throw new Error('Update failed');
          await loadPlans();
        }
      } catch (e) {
        alert('Aggiornamento stato scheda fallito');
        if (el) el.checked = !checked;
      }
    }

    async function createPlan() {
      if (!currentClient) return alert('Seleziona un cliente');
      const titolo = prompt('Titolo scheda?');
      if (titolo === null) return;
      const descrizione = prompt('Descrizione (facoltativa)') || null;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify({ user_id: currentClient.id, titolo, descrizione })});
      if (!r.ok) return alert('Creazione fallita');
      await loadPlans();
    }

    async function deletePlan() {
      if (!currentPlan) return;
      if (!confirm('Eliminare questa scheda?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(currentPlan.id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione fallita');
      currentPlan = null;
      await loadPlans();
    }

    async function deleteSession(id) {
      if (!confirm('Eliminare la sessione?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/sessions/${encodeURIComponent(id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione sessione fallita');
      openPlan(currentPlan);
    }

    async function deleteExercise(id) {
      if (!confirm('Eliminare esercizio?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/exercises/${encodeURIComponent(id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione esercizio fallita');
      openPlan(currentPlan);
    }

    // Webhook notification function is now loaded from shared/js/webhooks.js

    // Chiudi popup con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.popup-overlay.active').forEach(popup => {
          closePopup(popup.id);
        });
      }
    });

    // Chiudi popup cliccando fuori
    document.querySelectorAll('.popup-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === this) {
          closePopup(this.id);
        }
      });
    });

    // Init
    loadClients();
  </script>
</body>
</html>
