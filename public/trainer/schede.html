<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GymTracker - Gestione Schede</title>
  <base href="/gymtracker/">
  <link rel="stylesheet" href="shared/css/shared.css">
  <link rel="stylesheet" href="trainer/css/trainer.css">
  <style>
    .layout { display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    .sidebar { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .plans { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .client-item { padding: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .client-item:hover { background: #f8fafc; }
    .client-item.active { background: #ecfdf5; border: 1px solid #10b981; }
    .badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; }
    .badge.active { background: #ecfdf5; color: #065f46; }
    .badge.inactive { background: #f1f5f9; color: #334155; }
    .plan-item { padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 6px; cursor: pointer; }
    .plan-item.active { background: #ecfdf5; border-color: #10b981; }
    .session { border: 1px dashed #e2e8f0; padding: 10px; border-radius: 6px; margin-bottom: 8px; }
    .exercise { display:flex; gap: 8px; align-items:center; padding: 6px 0; border-bottom: 1px solid #f1f5f9; }
    .exercise:last-child { border-bottom: none; }
    .plus { cursor:pointer; padding: 4px 8px; border-radius: 4px; border:1px solid #10b981; color:#065f46; background:#ecfdf5; }
  </style>
</head>
<body>
  <div data-include="shared/partials/header.html"></div>
  <main class="trainer-dashboard">
    <div class="dashboard-header">
      <h1>üìã Gestione Schede</h1>
      <div class="trainer-actions">
        <button class="btn-secondary" onclick="window.location.href='trainer/dashboard.html'">‚Üê Torna alla Dashboard</button>
      </div>
    </div>
    <div class="layout" style="grid-template-columns: 1fr;">
      <section class="plans" style="grid-column: 1 / -1;">
        <!-- Riga superiore: a sinistra combo clienti (con filtro), a destra elenco schede -->
        <div class="flex" style="gap:16px; align-items:flex-start;">
          <div style="width:320px;">
            <div class="flex-between mb-2">
              <strong>Clienti</strong>
              <select id="filterActive" class="filter-select" onchange="loadClients()">
                <option value="all">Tutti</option>
                <option value="true" selected>Attivi</option>
                <option value="false">Disattivati</option>
              </select>
            </div>
            <div class="form-group">
              <label>Seleziona cliente</label>
              <select id="clientSelect" class="filter-select" onchange="onClientChange()">
                <option value="">-- Seleziona --</option>
              </select>
            </div>
            <div class="form-group">
              <label style="display:block;">Stato cliente</label>
              <label style="font-size:12px; color:#64748b; margin-right:6px;">attivo</label>
              <input type="checkbox" id="clientActiveToggle" onchange="onClientActiveToggleChange(this.checked)" />
            </div>
            <button class="plus" onclick="createPlan()">+ Nuova scheda</button>
          </div>
          <div style="flex:1;">
            <div><strong>Schede cliente</strong></div>
            <div id="plansList" class="mt-1"></div>
          </div>
        </div>

        <!-- Riga inferiore: dettaglio scheda a tutta larghezza -->
        <div class="mt-2" style="margin-top:16px;">
          <div id="planDetail"></div>
        </div>
      </section>
    </div>
  </main>

  <script src="shared/js/core/api.js"></script>
  <script src="shared/js/include.js"></script>
  <script>
    if (!GymAPI.isAuthenticated()) {
      window.location.href = '/gymtracker/utente/';
    }

    let currentClient = null;
    let currentPlans = [];
    let currentPlan = null;
    let clientsData = [];

    async function loadClients() {
      const active = document.getElementById('filterActive').value;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/clients?active=${active}`, { headers: { Authorization: 'Bearer ' + t }});
      const { clients } = await r.json();
      clientsData = clients || [];
      const sel = document.getElementById('clientSelect');
      const prev = sel.value;
      sel.innerHTML = '<option value="">-- Seleziona --</option>';
      clientsData.forEach(c => {
        const label = c.full_name ? `${c.full_name} (${c.email})` : (c.email || 'Senza nome');
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = label;
        sel.appendChild(opt);
      });
      // Pre-selezione da query ?user_id=..., poi mantieni selezione precedente, poi primo
      const q = new URLSearchParams(window.location.search);
      const qUser = q.get('user_id');
      if (qUser && clientsData.some(c => c.id === qUser)) {
        sel.value = qUser;
      } else if (prev && clientsData.some(c => c.id === prev)) {
        sel.value = prev;
      } else if (clientsData.length) {
        sel.value = clientsData[0].id;
      }
      onClientChange();
    }

    function onClientChange() {
      const sel = document.getElementById('clientSelect');
      const id = sel.value;
      currentClient = clientsData.find(c => c.id === id) || null;
      // Aggiorna toggle stato cliente
      const toggle = document.getElementById('clientActiveToggle');
      if (currentClient) {
        toggle.disabled = false;
        toggle.checked = !!currentClient.utente_attivo;
      } else {
        toggle.checked = false;
        toggle.disabled = true;
      }
      loadPlans();
    }

    async function onClientActiveToggleChange(checked) {
      if (!currentClient) return;
      const id = currentClient.id;
      const t = GymAPI.getToken();
      const sel = document.getElementById('clientSelect');
      try {
        const r = await fetch(`${GymAPI.baseURL}/trainer/clients/${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: { 'Content-Type':'application/json', Authorization:'Bearer '+t },
          body: JSON.stringify({ utente_attivo: !!checked })
        });
        if (!r.ok) throw new Error('update failed');
        // ricarica elenco clienti preservando selezione (potrebbe sparire se filtrato)
        const keepId = id;
        await loadClients();
        // se il client non √® pi√π nel filtro, la select cadr√† su altro ID
        const after = document.getElementById('clientSelect').value;
        if (after !== keepId) {
          // Se √® sparito per via del filtro, azzera piani e dettagli
          currentPlan = null;
          currentPlans = [];
          document.getElementById('plansList').innerHTML = '';
          document.getElementById('planDetail').innerHTML = '';
        }
      } catch (e) {
        alert('Aggiornamento stato cliente fallito');
        // ripristina toggle
        document.getElementById('clientActiveToggle').checked = !!(currentClient && currentClient.utente_attivo);
      }
    }

    async function loadPlans() {
      if (!currentClient) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans?user_id=${encodeURIComponent(currentClient.id)}`, { headers: { Authorization: 'Bearer ' + t }});
      const { plans } = await r.json();
      currentPlans = plans || [];
      const box = document.getElementById('plansList');
      box.innerHTML = '';
      currentPlans.forEach(p => {
        const d = document.createElement('div');
        d.className = 'plan-item' + (currentPlan && currentPlan.id === p.id ? ' active' : '');
        d.innerHTML = `<span>${p.titolo || '(Senza titolo)'}</span>
          <span style=\"float:right\"> <label style=\"font-size:12px; color:#64748b; margin-right:6px;\">attiva</label>
            <input type=\"checkbox\" ${p.attiva!==false?'checked':''}
              onclick=\"event.stopPropagation(); togglePlanActive('${p.id}', this.checked, this)\"/>
          </span>`;
        d.onclick = () => openPlan(p, d);
        box.appendChild(d);
      });
      document.getElementById('planDetail').innerHTML = '';
    }

    async function openPlan(p, el) {
      currentPlan = p;
      // evidenzia scheda selezionata
      document.querySelectorAll('#plansList .plan-item').forEach(i => i.classList.remove('active'));
      if (el) el.classList.add('active');
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(p.id)}`, { headers: { Authorization: 'Bearer ' + t }});
      const { plan, sessions, exercises } = await r.json();
      const box = document.getElementById('planDetail');
      let html = '';
      html += `<div class="card"><div class="card-header"><h3>Dettagli scheda</h3></div>`;
      html += `<div class="form-group"><label>Titolo</label><input id="planTitle" type="text" value="${plan.titolo || ''}"></div>`;
      html += `<div class="form-group"><label>Descrizione</label><textarea id="planDesc">${plan.descrizione || ''}</textarea></div>`;
      html += `<div class="flex" style="gap:12px;">
                 <div class="form-group" style="flex:1"><label>Autore</label><input id="planAuthor" type="text" value="${plan.autore || ''}"></div>
                 <div class="form-group" style="width:180px"><label>Durata (settimane)</label><input id="planWeeks" type="number" min="1" max="52" value="${plan.durata_settimane || ''}"></div>
                 <div class="form-group" style="width:220px"><label>Sessioni/settimana</label><input id="planSpw" type="number" min="1" max="14" value="${plan.sessioni_settimana || ''}"></div>
               </div>`;
      html += `<button class="btn-primary" onclick="savePlan('${plan.id}')">Salva scheda</button>`;
      html += `<div class="flex-between" style="margin:10px 0;"><strong>SESSIONI</strong><button class="plus" onclick="createSession()">+ Aggiungi sessione</button></div>`;
      sessions.forEach(s => {
        html += `<div class="session">`;
        html += `<div class="form-group"><label>Nome sessione</label><input type="text" id="sess_${s.id}_name" value="${s.nome}"/></div>`;
        html += `<div class="flex-between">`;
        html += `<div><button class="btn btn-sm" onclick="saveSession('${s.id}')">Salva sessione</button> <button class="plus" onclick="createExercise('${s.id}')">+ Esercizio</button></div>`;
        html += `<button class="btn btn-sm" onclick="deleteSession('${s.id}')">Elimina sessione</button>`;
        html += `</div>`;
        const list = exercises.filter(e => e.sessione_id === s.id);
        if (!list.length) html += `<div style="color:#64748b;">Nessun esercizio</div>`;
        list.forEach(e => {
          html += `<div class="exercise">`;
          html += `<input style="width:28%" id="ex_${e.id}_name" value="${e.name}"/>`;
          html += ` S:<input style="width:50px" id="ex_${e.id}_sets" type="number" value="${e.sets_count||3}"/>`;
          html += ` Rip:<input style="width:50px" id="ex_${e.id}_rmin" type="number" value="${e.reps_min||8}"/>-<input style="width:50px" id="ex_${e.id}_rmax" type="number" value="${e.reps_max||12}"/>`;
          html += ` Kg:<input style="width:70px" id="ex_${e.id}_kg" type="number" step="0.1" value="${e.weight_suggested||0}"/>`;
          html += ` Rest:<input style="width:60px" id="ex_${e.id}_rest" type="number" value="${e.rest_seconds||90}"/>`;
          html += ` Int:<select id="ex_${e.id}_int" style="width:70px">${Array.from({length:11},(_,i)=>`<option value="${i}" ${e.intensity==i?'selected':''}>${i}</option>`).join('')}</select>`;
          html += ` URL:<input style="width:18%" id="ex_${e.id}_url" type="url" placeholder="https://..." value="${e.external_url||''}"/>`;
          html += ` <button class="btn btn-sm" onclick="saveExercise('${e.id}')">Salva</button>`;
          html += ` <button class="btn btn-sm" onclick="deleteExercise('${e.id}')">üóë</button>`;
          html += `</div>`;
        });
        html += `</div>`;
      });
      html += `<div class="mt-2"><button class="btn btn-sm btn-logout" onclick="deletePlan()">Elimina scheda</button></div>`;
      html += `</div>`;
      box.innerHTML = html;
    }

    async function savePlan(id) {
      const payload = {
        titolo: document.getElementById('planTitle').value,
        descrizione: document.getElementById('planDesc').value,
        autore: document.getElementById('planAuthor').value || null,
        durata_settimane: (()=>{ const v=document.getElementById('planWeeks').value; return v===''? null : parseInt(v,10); })(),
        sessioni_settimana: (()=>{ const v=document.getElementById('planSpw').value; return v===''? null : parseInt(v,10); })()
      };
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(id)}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify(payload) });
      if (!r.ok) return alert('Salvataggio scheda fallito');
      await loadPlans();
      // riapri e mantieni evidenza
      const el = Array.from(document.querySelectorAll('#plansList .plan-item'))
        .find(node => (node.textContent || '') === (currentPlan.titolo || '(Senza titolo)')) || null;
      openPlan(currentPlan, el);
    }

    // toggleClientActive non pi√π usato: gestione client solo via combo e filtro

    async function togglePlanActive(id, checked, el) {
      try {
        const t = GymAPI.getToken();
        if (checked) {
          // Consenti selezione solo se non esistono altre schede attive
          const otherActive = (currentPlans || []).some(p => p.id !== id && p.attiva !== false);
          if (otherActive) {
            alert("Disattiva le altre schede prima di selezionarne un'altra.");
            if (el) el.checked = false; // non lasciare spuntare una nuova scheda
            return;
          }
          // Attiva solo questa scheda senza auto-disattivare le altre lato client
          const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(id)}`, {
            method: 'PUT', headers: { 'Content-Type':'application/json', Authorization:'Bearer '+t },
            body: JSON.stringify({ attiva: true })
          });
          if (!r.ok) throw new Error('Activate failed');
          await loadPlans();
        } else {
          // Consenti disattivazione esplicita
          const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(id)}`, {
            method: 'PUT', headers: { 'Content-Type':'application/json', Authorization:'Bearer '+t },
            body: JSON.stringify({ attiva: false })
          });
          if (!r.ok) throw new Error('Update failed');
          await loadPlans();
        }
      } catch (e) {
        alert('Aggiornamento stato scheda fallito');
        // Ripristina stato precedente in caso di errore
        if (el) el.checked = !checked;
      }
    }

    async function saveSession(id) {
      const payload = {
        nome: document.getElementById(`sess_${id}_name`).value
      };
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/sessions/${encodeURIComponent(id)}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify(payload) });
      if (!r.ok) return alert('Salvataggio sessione fallito');
      openPlan(currentPlan);
    }

    async function saveExercise(id) {
      const payload = {
        name: document.getElementById(`ex_${id}_name`).value,
        sets_count: parseInt(document.getElementById(`ex_${id}_sets`).value||'3',10),
        reps_min: parseInt(document.getElementById(`ex_${id}_rmin`).value||'8',10),
        reps_max: parseInt(document.getElementById(`ex_${id}_rmax`).value||'12',10),
        weight_suggested: parseFloat(document.getElementById(`ex_${id}_kg`).value||'0'),
        rest_seconds: parseInt(document.getElementById(`ex_${id}_rest`).value||'90',10),
        intensity: parseInt(document.getElementById(`ex_${id}_int`).value||'0',10),
        external_url: (document.getElementById(`ex_${id}_url`).value||'').trim() || null
      };
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/exercises/${encodeURIComponent(id)}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify(payload) });
      if (!r.ok) return alert('Salvataggio esercizio fallito');
      openPlan(currentPlan);
    }

    async function createPlan() {
      if (!currentClient) return alert('Seleziona un cliente');
      const titolo = prompt('Titolo scheda?');
      if (titolo === null) return;
      const descrizione = prompt('Descrizione (facoltativa)') || null;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify({ user_id: currentClient.id, titolo, descrizione })});
      if (!r.ok) return alert('Creazione fallita');
      await loadPlans();
    }

    async function deletePlan() {
      if (!currentPlan) return;
      if (!confirm('Eliminare questa scheda?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(currentPlan.id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione fallita');
      currentPlan = null;
      await loadPlans();
    }

    async function createSession() {
      if (!currentPlan) return alert('Apri una scheda');
      const nome = prompt('Nome sessione?');
      if (nome === null) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/sessions`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify({ scheda_id: currentPlan.id, nome })});
      if (!r.ok) return alert('Creazione sessione fallita');
      openPlan(currentPlan);
    }

    async function deleteSession(id) {
      if (!confirm('Eliminare la sessione?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/sessions/${encodeURIComponent(id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione sessione fallita');
      openPlan(currentPlan);
    }

    async function createExercise(sessionId) {
      const name = prompt('Nome esercizio?');
      if (name === null) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/exercises`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify({ sessione_id: sessionId, name })});
      if (!r.ok) return alert('Creazione esercizio fallita');
      openPlan(currentPlan);
    }

    async function deleteExercise(id) {
      if (!confirm('Eliminare esercizio?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/exercises/${encodeURIComponent(id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione esercizio fallita');
      openPlan(currentPlan);
    }

    // Init
    loadClients();
  </script>
</body>
</html>
