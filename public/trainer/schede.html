<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GymTracker - Gestione Schede</title>
  <base href="/gymtracker/">
  <link rel="stylesheet" href="shared/css/shared.css">
  <link rel="stylesheet" href="trainer/css/trainer.css">
  <style>
    .layout { display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    .sidebar { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .plans { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .client-item { padding: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .client-item:hover { background: #f8fafc; }
    .client-item.active { background: #ecfdf5; border: 1px solid #10b981; }
    .badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; }
    .badge.active { background: #ecfdf5; color: #065f46; }
    .badge.inactive { background: #f1f5f9; color: #334155; }
    .plan-item { padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 6px; cursor: pointer; }
    .plan-item.active { background: #ecfdf5; border-color: #10b981; }
    .session { border: 1px dashed #e2e8f0; padding: 10px; border-radius: 6px; margin-bottom: 8px; }
    .exercise { display:flex; gap: 8px; align-items:center; padding: 6px 0; border-bottom: 1px solid #f1f5f9; }
    .exercise:last-child { border-bottom: none; }
    .plus { cursor:pointer; padding: 4px 8px; border-radius: 4px; border:1px solid #10b981; color:#065f46; background:#ecfdf5; }
  </style>
</head>
<body>
  <div data-include="shared/partials/header.html"></div>
  <main class="trainer-dashboard">
    <div class="dashboard-header">
      <h1>üìã Gestione Schede</h1>
      <div class="trainer-actions">
        <button class="btn-secondary" onclick="window.location.href='trainer/dashboard.html'">‚Üê Torna alla Dashboard</button>
      </div>
    </div>
    <div class="layout">
      <aside class="sidebar">
        <div class="flex-between mb-2">
          <strong>Clienti</strong>
          <select id="filterActive" class="filter-select" onchange="loadClients()">
            <option value="all">Tutti</option>
            <option value="true">Attivi</option>
            <option value="false">Disattivati</option>
          </select>
        </div>
        <div id="clientsList"></div>
      </aside>
      <section class="plans">
        <div class="flex-between mb-2">
          <strong id="currentClientName">Seleziona un cliente</strong>
          <button class="plus" onclick="createPlan()">+ Nuova scheda</button>
        </div>
        <div class="flex" style="gap: 16px;">
          <div style="width: 280px;">
            <div id="plansList"></div>
          </div>
          <div style="flex:1;">
            <div id="planDetail"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script src="shared/js/core/api.js"></script>
  <script src="shared/js/include.js"></script>
  <script>
    if (!GymAPI.isAuthenticated()) {
      window.location.href = '/gymtracker/utente/';
    }

    let currentClient = null;
    let currentPlans = [];
    let currentPlan = null;

    async function loadClients() {
      const active = document.getElementById('filterActive').value;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/clients?active=${active}`, { headers: { Authorization: 'Bearer ' + t }});
      const { clients } = await r.json();
      const box = document.getElementById('clientsList');
      box.innerHTML = '';
      clients.forEach(c => {
        const div = document.createElement('div');
        div.className = 'client-item';
        const label = c.full_name ? `${c.full_name} (${c.email})` : (c.email || 'Senza nome');
        div.innerHTML = `<span>${label}</span>
          <span>
            <label style=\"font-size:12px; color:#64748b; margin-right:6px;\">attivo</label>
            <input type=\"checkbox\" ${c.utente_attivo?'checked':''}
              onclick=\"event.stopPropagation(); toggleClientActive('${c.id}', this.checked, this)\"/>
          </span>`;
        div.onclick = () => selectClient(c, div);
        box.appendChild(div);
      });
    }

    async function selectClient(c, el) {
      currentClient = c;
      document.querySelectorAll('#clientsList .client-item').forEach(i => i.classList.remove('active'));
      if (el) el.classList.add('active');
      const label = c.full_name ? `${c.full_name} (${c.email})` : (c.email || 'Senza nome');
      document.getElementById('currentClientName').textContent = label;
      await loadPlans();
    }

    async function loadPlans() {
      if (!currentClient) return;
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans?user_id=${encodeURIComponent(currentClient.id)}`, { headers: { Authorization: 'Bearer ' + t }});
      const { plans } = await r.json();
      currentPlans = plans || [];
      const box = document.getElementById('plansList');
      box.innerHTML = '';
      currentPlans.forEach(p => {
        const d = document.createElement('div');
        d.className = 'plan-item' + (currentPlan && currentPlan.id === p.id ? ' active' : '');
        d.innerHTML = `<span>${p.titolo || '(Senza titolo)'}</span>
          <span style=\"float:right\"> <label style=\"font-size:12px; color:#64748b; margin-right:6px;\">attiva</label>
            <input type=\"checkbox\" ${p.attiva!==false?'checked':''}
              onclick=\"event.stopPropagation(); togglePlanActive('${p.id}', this.checked)\"/>
          </span>`;
        d.onclick = () => openPlan(p, d);
        box.appendChild(d);
      });
      document.getElementById('planDetail').innerHTML = '';
    }

    async function openPlan(p, el) {
      currentPlan = p;
      // evidenzia scheda selezionata
      document.querySelectorAll('#plansList .plan-item').forEach(i => i.classList.remove('active'));
      if (el) el.classList.add('active');
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(p.id)}`, { headers: { Authorization: 'Bearer ' + t }});
      const { plan, sessions, exercises } = await r.json();
      const box = document.getElementById('planDetail');
      let html = '';
      html += `<div class="card"><div class="card-header"><h3>Intestazione scheda</h3></div>`;
      html += `<div class="form-group"><label>Titolo</label><input id="planTitle" type="text" value="${plan.titolo || ''}"></div>`;
      html += `<div class="form-group"><label>Descrizione</label><textarea id="planDesc">${plan.descrizione || ''}</textarea></div>`;
      html += `<div class="form-group"><label><input id="planActive" type="checkbox" ${plan.attiva!==false?'checked':''}> Attiva</label></div>`;
      html += `<button class="btn-primary" onclick="savePlan('${plan.id}')">Salva scheda</button>`;
      html += `<div class="flex-between" style="margin:10px 0;"><strong>SESSIONI</strong><button class="plus" onclick="createSession()">+ Aggiungi sessione</button></div>`;
      sessions.sort((a,b)=>(a.ordine||0)-(b.ordine||0)).forEach(s => {
        html += `<div class="session">`;
        html += `<div class="form-group"><label>Nome sessione</label><input type="text" id="sess_${s.id}_name" value="${s.nome}"/></div>`;
        html += `<div class="form-group"><label>Ordine</label><input type="number" id="sess_${s.id}_ord" value="${s.ordine||1}"/></div>`;
        html += `<div class="flex-between">`;
        html += `<div><button class="btn btn-sm" onclick="saveSession('${s.id}')">Salva sessione</button> <button class="plus" onclick="createExercise('${s.id}')">+ Esercizio</button></div>`;
        html += `<button class="btn btn-sm" onclick="deleteSession('${s.id}')">Elimina sessione</button>`;
        html += `</div>`;
        const list = exercises.filter(e => e.sessione_id === s.id);
        if (!list.length) html += `<div style="color:#64748b;">Nessun esercizio</div>`;
        list.forEach(e => {
          html += `<div class="exercise">`;
          html += `<input style="width:30%" id="ex_${e.id}_name" value="${e.name}"/>`;
          html += ` S:<input style="width:50px" id="ex_${e.id}_sets" type="number" value="${e.sets_count||3}"/>`;
          html += ` Rip:<input style="width:50px" id="ex_${e.id}_rmin" type="number" value="${e.reps_min||8}"/>-<input style="width:50px" id="ex_${e.id}_rmax" type="number" value="${e.reps_max||12}"/>`;
          html += ` Kg:<input style="width:70px" id="ex_${e.id}_kg" type="number" step="0.1" value="${e.weight_suggested||0}"/>`;
          html += ` Rest:<input style="width:60px" id="ex_${e.id}_rest" type="number" value="${e.rest_seconds||90}"/>`;
          html += ` <button class="btn btn-sm" onclick="saveExercise('${e.id}')">Salva</button>`;
          html += ` <button class="btn btn-sm" onclick="deleteExercise('${e.id}')">üóë</button>`;
          html += `</div>`;
        });
        html += `</div>`;
      });
      html += `<div class="mt-2"><button class="btn btn-sm btn-logout" onclick="deletePlan()">Elimina scheda</button></div>`;
      html += `</div>`;
      box.innerHTML = html;
    }

    async function savePlan(id) {
      const payload = {
        titolo: document.getElementById('planTitle').value,
        descrizione: document.getElementById('planDesc').value,
        attiva: document.getElementById('planActive').checked
      };
      const t = GymAPI.getToken();
      const r = await fetch(`${GymAPI.baseURL}/trainer/plans/${encodeURIComponent(id)}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify(payload) });
      if (!r.ok) return alert('Salvataggio scheda fallito');
      await loadPlans();
      // riapri e mantieni evidenza
      const el = Array.from(document.querySelectorAll('#plansList .plan-item'))
        .find(node => (node.textContent || '') === (currentPlan.titolo || '(Senza titolo)')) || null;
      openPlan(currentPlan, el);
    }

    async function toggleClientActive(id, checked, el) {
      const prev = checked;
      if (el) el.disabled = true;
      try {
        const t = GymAPI.getToken();
        const r = await fetch(`${GymAPI.baseURL}/trainer/clients/${encodeURIComponent(id)}`, {
          method: 'PUT', headers: { 'Content-Type':'application/json', Authorization:'Bearer '+t },
          body: JSON.stringify({ utente_attivo: !!checked })
        });
        if (!r.ok) throw new Error('Update failed');
        // Refresh list according to current filter
        await loadClients();
        // Clear selection if filtered out
        currentClient = null;
        document.getElementById('currentClientName').textContent = 'Seleziona un cliente';
        document.getElementById('plansList').innerHTML = '';
        document.getElementById('planDetail').innerHTML = '';
      } catch (e) {
        alert('Aggiornamento attivo/disattivo fallito');
        if (el) el.checked = !prev;
      } finally {
        if (el) el.disabled = false;
      }
    }

    async function togglePlanActive(id, checked) {
      try {
        const t = GymAPI.getToken();
        const r = await fetch(`/api/trainer/plans/${encodeURIComponent(id)}`, {
          method: 'PUT', headers: { 'Content-Type':'application/json', Authorization:'Bearer '+t },
          body: JSON.stringify({ attiva: !!checked })
        });
        if (!r.ok) throw new Error('Update failed');
      } catch (e) {
        alert('Aggiornamento stato scheda fallito');
      }
    }

    async function saveSession(id) {
      const payload = {
        nome: document.getElementById(`sess_${id}_name`).value,
        ordine: parseInt(document.getElementById(`sess_${id}_ord`).value||'1',10)
      };
      const t = GymAPI.getToken();
      const r = await fetch(`/api/trainer/sessions/${encodeURIComponent(id)}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify(payload) });
      if (!r.ok) return alert('Salvataggio sessione fallito');
      openPlan(currentPlan);
    }

    async function saveExercise(id) {
      const payload = {
        name: document.getElementById(`ex_${id}_name`).value,
        sets_count: parseInt(document.getElementById(`ex_${id}_sets`).value||'3',10),
        reps_min: parseInt(document.getElementById(`ex_${id}_rmin`).value||'8',10),
        reps_max: parseInt(document.getElementById(`ex_${id}_rmax`).value||'12',10),
        weight_suggested: parseFloat(document.getElementById(`ex_${id}_kg`).value||'0'),
        rest_seconds: parseInt(document.getElementById(`ex_${id}_rest`).value||'90',10)
      };
      const t = GymAPI.getToken();
      const r = await fetch(`/api/trainer/exercises/${encodeURIComponent(id)}`, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify(payload) });
      if (!r.ok) return alert('Salvataggio esercizio fallito');
      openPlan(currentPlan);
    }

    async function createPlan() {
      if (!currentClient) return alert('Seleziona un cliente');
      const titolo = prompt('Titolo scheda?');
      if (titolo === null) return;
      const descrizione = prompt('Descrizione (facoltativa)') || null;
      const t = GymAPI.getToken();
      const r = await fetch('/api/trainer/plans', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify({ user_id: currentClient.id, titolo, descrizione })});
      if (!r.ok) return alert('Creazione fallita');
      await loadPlans();
    }

    async function deletePlan() {
      if (!currentPlan) return;
      if (!confirm('Eliminare questa scheda?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`/api/trainer/plans/${encodeURIComponent(currentPlan.id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione fallita');
      currentPlan = null;
      await loadPlans();
    }

    async function createSession() {
      if (!currentPlan) return alert('Apri una scheda');
      const nome = prompt('Nome sessione?');
      if (nome === null) return;
      const t = GymAPI.getToken();
      const r = await fetch('/api/trainer/sessions', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify({ scheda_id: currentPlan.id, nome })});
      if (!r.ok) return alert('Creazione sessione fallita');
      openPlan(currentPlan);
    }

    async function deleteSession(id) {
      if (!confirm('Eliminare la sessione?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`/api/trainer/sessions/${encodeURIComponent(id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione sessione fallita');
      openPlan(currentPlan);
    }

    async function createExercise(sessionId) {
      const name = prompt('Nome esercizio?');
      if (name === null) return;
      const t = GymAPI.getToken();
      const r = await fetch('/api/trainer/exercises', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+t }, body: JSON.stringify({ sessione_id: sessionId, name })});
      if (!r.ok) return alert('Creazione esercizio fallita');
      openPlan(currentPlan);
    }

    async function deleteExercise(id) {
      if (!confirm('Eliminare esercizio?')) return;
      const t = GymAPI.getToken();
      const r = await fetch(`/api/trainer/exercises/${encodeURIComponent(id)}`, { method:'DELETE', headers:{ Authorization:'Bearer '+t }});
      if (!r.ok) return alert('Eliminazione esercizio fallita');
      openPlan(currentPlan);
    }

    // Init
    loadClients();
  </script>
</body>
</html>
