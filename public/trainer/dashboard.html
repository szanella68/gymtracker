<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymTracker - Dashboard Trainer</title>
    <base href="/gymtracker/">
    <link rel="stylesheet" href="shared/css/shared.css">
    <link rel="stylesheet" href="trainer/css/trainer.css">
</head>
<body>
    <div data-include="shared/partials/header.html"></div>
    <main class="trainer-dashboard">
        <div class="dashboard-header">
            <h1>🧑‍🏫 Dashboard Trainer</h1>
            <div class="trainer-actions"></div>
        </div>

        <!-- Navigazione principale -->
        <div class="trainer-nav nav-menu">
            <a href="trainer/clienti.html" class="nav-card primary">
                <div class="nav-icon">👥</div>
                <h3>Gestione Clienti</h3>
                <p>Visualizza e gestisci i tuoi clienti</p>
            </a>
            
            <a href="trainer/schede.html" class="nav-card">
                <div class="nav-icon">📋</div>
                <h3>Creazione Schede</h3>
                <p>Crea e modifica programmi di allenamento</p>
            </a>
            
            <a href="trainer/calendario.html" class="nav-card">
                <div class="nav-icon">📅</div>
                <h3>Pianificazione</h3>
                <p>Assegna e programma allenamenti</p>
            </a>
            
            <a href="trainer/report.html" class="nav-card">
                <div class="nav-icon">📊</div>
                <h3>Report & Analytics</h3>
                <p>Analisi performance e progressi</p>
            </a>
        </div>

        <!-- Trainer Stats Compatte -->
        <div class="card">
            <div class="card-header">
                <h3>📊 Statistiche Generali</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-info">
                        <h3 id="totalClients">--</h3>
                        <p>Clienti attivi</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📋</div>
                    <div class="stat-info">
                        <h3 id="activePrograms">--</h3>
                        <p>Programmi attivi</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📈</div>
                    <div class="stat-info">
                        <h3 id="avgAdherence">--</h3>
                        <p>Aderenza media</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📅</div>
                    <div class="stat-info">
                        <h3 id="todaySessions">--</h3>
                        <p>Sessioni oggi</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🔥</div>
                    <div class="stat-info">
                        <h3 id="weekStreak">--</h3>
                        <p>Serie settimanale</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attività recenti (ripristinato contenitore) -->
        <div class="card">
            <div class="card-header">
                <h3>📋 Attività Recenti</h3>
            </div>
            <div id="recentActivities"></div>
        </div>

        <!-- 1) Clienti attivi/inattivi (torta) -->
        <div class="card">
            <div class="card-header"><h3>👥 Clienti Attivi vs Non Attivi</h3></div>
            <div class="flex" style="gap:20px; align-items:center;">
                <svg id="clientsPie" width="160" height="160" viewBox="0 0 160 160"></svg>
                <div>
                    <div><strong>Attivi:</strong> <span id="activeCount">--</span></div>
                    <div><strong>Non attivi:</strong> <span id="inactiveCount">--</span></div>
                    <div style="color:#6c757d; font-size:14px;">Periodo: ultime 8 settimane</div>
                </div>
            </div>
        </div>

        <!-- 2) Gantt settimanale per clienti -->
        <div class="card">
            <div class="card-header"><h3>🗂️ Piano settimanale (fatto/da fare)</h3></div>
            <div class="gantt-container">
                <div id="ganttWeeks" class="gantt-weeks"></div>
                <div id="ganttGrid" class="gantt-grid"></div>
            </div>
        </div>

        <!-- 3) Pareto puntualità -->
        <div class="card">
            <div class="card-header"><h3>🏅 Top 10 Puntualità</h3></div>
            <div id="paretoPunctual" class="pareto-list"></div>
        </div>

        <!-- 4) Trend in miglioramento -->
        <div class="card">
            <div class="card-header"><h3>📈 Trend in crescita</h3></div>
            <div id="paretoTrend" class="pareto-list"></div>
        </div>

        <!-- 5) Ritardatari -->
        <div class="card">
            <div class="card-header"><h3>⏳ Ritardatari</h3></div>
            <div id="paretoLaggards" class="pareto-list"></div>
        </div>

        <!-- Gestione utente spostata in trainer/clienti.html -->
        
        <!-- Clients needing attention -->
        <div class="attention-needed">
            <h2>⚠️ Clienti che richiedono attenzione</h2>
            <div id="attentionClients">
                <!-- Popolato dinamicamente -->
                <div class="empty-state">
                    <div class="empty-icon">✅</div>
                    <h3>Tutti i clienti sono in regola</h3>
                    <p>Nessun cliente richiede attenzione al momento.</p>
                </div>
            </div>
        </div>
        
    </main>

    <!-- New Client Modal -->
    <div id="newClientModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('newClientModal')">&times;</button>
            <h2>Nuovo Cliente</h2>
            <form id="newClientForm">
                <div class="form-group">
                    <label for="clientName">Nome completo</label>
                    <input type="text" id="clientName" name="full_name" required>
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="clientPhone">Telefono</label>
                    <input type="tel" id="clientPhone" name="phone">
                </div>
                <div class="form-group">
                    <label for="clientGoal">Obiettivo principale</label>
                    <textarea id="clientGoal" name="fitness_goal" rows="3" placeholder="Descrivere l'obiettivo del cliente..."></textarea>
                </div>
                <div class="form-group">
                    <label for="experienceLevel" class="modern-label"><span class="label-text">Livello esperienza</span></label>
                    <select id="experienceLevel" name="experience_level" class="modern-select">
                        <option value="">Seleziona</option>
                        <option value="beginner">Principiante</option>
                        <option value="intermediate">Intermedio</option>
                        <option value="advanced">Avanzato</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-add btn-with-icon w-full">➕ Crea Cliente</button>
                <div id="newClientError" class="error-message" style="display: none;"></div>
            </form>
        </div>
    </div>
    <div data-include="shared/partials/footer.html"></div>

    <script src="shared/js/core/api.js"></script>
    <script src="shared/js/include.js"></script>
    <script src="shared/js/core/utils.js"></script>
    <script>
        // Auth + role check
        async function checkTrainerAccess() {
            const token = GymAPI.getToken();
            if (!token) {
                window.location.href = '/gymtracker/utente/';
                return;
            }
            
            try {
                const userProfile = await GymAPI.getCurrentUser();
                const role = (userProfile?.profile?.user_type || userProfile?.user_type || '').toString().toLowerCase();
                if (role !== 'admin') {
                    alert('Accesso riservato agli amministratori');
                    window.location.href = '/gymtracker/utente/dashboard.html';
                    return;
                }
                
                await loadTrainerDashboard();
                await loadOverview();
                
            } catch (error) {
                console.error('Auth check failed:', error);
                GymAPI.removeToken();
                window.location.href = '/gymtracker/utente/';
            }
        }

        async function loadOverview(){
            const weeks = 24;
            const data = await GymAPI.get(`/trainer/dashboard/overview?weeks=${weeks}`);
            // Pie
            (function(e){if(e) e.textContent = data.active_count;})(document.getElementById('activeCount'));
            (function(e){if(e) e.textContent = data.inactive_count;})(document.getElementById('inactiveCount'));
            (function(el){ if(el) renderPie('clientsPie', data.active_count, data.inactive_count); })(document.getElementById('clientsPie'));
            // Gantt headers
            const gw = document.getElementById('ganttWeeks');
            if (gw) {
                gw.innerHTML = data.weeks.map(w => `<div class="w">${new Date(w).toLocaleDateString('it-IT', { month:'2-digit', day:'2-digit' })}</div>`).join('');
                const totalW = weeks*60 + (weeks-1)*6;
                gw.style.minWidth = totalW + 'px';
            }
            // Gantt rows
            const grid = document.getElementById('ganttGrid');
            if (grid) {
                const totalW = weeks*60 + (weeks-1)*6;
                grid.innerHTML = data.clients.map(c => `
                <div class="gantt-row">
                    <div class="gantt-name">${Utils.escapeHtml(c.name)}</div>
                    <div class="gantt-cells" style="min-width:${totalW}px">${c.weekly.map(x => `<div class="gantt-cell ${x.status}"></div>`).join('')}</div>
                </div>`).join('');
            }
            // Pareto punctuality (top 10)
            const byAdh = [...data.clients].sort((a,b)=> (b.adherence||0) - (a.adherence||0)).slice(0,10);
            renderPareto('paretoPunctual', byAdh, v => v.adherence, '%', false);
            // Trend up
            const byTrend = [...data.clients].filter(x=> (x.trendDelta||0)>0).sort((a,b)=> (b.trendDelta||0)-(a.trendDelta||0)).slice(0,10);
            renderPareto('paretoTrend', byTrend, v => v.trendDelta, 'pp', false);
            // Laggards
            const worst = [...data.clients].sort((a,b)=> (a.adherence||0)-(b.adherence||0)).slice(0,10);
            renderPareto('paretoLaggards', worst, v => v.adherence, '%', true);
            // Client select (se presente in pagina)
            const sel = document.getElementById('clientSelect');
            if (sel) sel.innerHTML = data.clients.map(c => `<option value="${c.id}">${Utils.escapeHtml(c.name)}</option>`).join('');
        }

        function renderPie(elId, act, inact){
            const total = Math.max(1, (act||0)+(inact||0));
            const frac = (act/total);
            const a = frac * 2*Math.PI;
            const r = 70, cx=80, cy=80;
            const large = a > Math.PI ? 1 : 0;
            const x = cx + r * Math.cos(a - Math.PI/2);
            const y = cy + r * Math.sin(a - Math.PI/2);
            const pathA = `M ${cx} ${cy-r} A ${r} ${r} 0 ${large} 1 ${x} ${y} L ${cx} ${cy} Z`;
            const svg = document.getElementById(elId);
            svg.innerHTML = `
                <circle cx="${cx}" cy="${cy}" r="${r}" fill="#e9ecef" />
                <path d="${pathA}" fill="#10b981" />
                <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central" font-size="18" fill="#0f172a">${Math.round(frac*100)}%</text>`;
        }

        function renderPareto(elId, arr, valFn, suffix, invert){
            const box = document.getElementById(elId);
            if (!box) return;
            box.innerHTML = arr.map(c => {
                const v = Math.max(0, Math.min(100, valFn(c) || 0));
                return `<div class="pareto-item">
                    <div style=\"min-width:200px;\">${Utils.escapeHtml(c.name)}</div>
                    <div class=\"pareto-bar\"><div class=\"pareto-fill ${invert?'down':''}\" style=\"width:${v}%;\"></div></div>
                    <div class=\"pareto-value\">${v}${suffix}</div>
                </div>`;
            }).join('');
        }
        
        async function loadTrainerDashboard() {
            try {
                // Load basic stats
                await Promise.all([
                    loadTrainerStats(),
                    loadRecentActivities(),
                    loadAttentionClients(),
                    loadQuickStats()
                ]);
                
            } catch (error) {
                console.error('Error loading trainer dashboard:', error);
                showDashboardError('Errore nel caricamento dei dati del trainer.');
            }
        }
        
        async function loadTrainerStats() {
            try {
                // Active clients: real count via API
                const token = GymAPI.getToken();
                const res = await fetch(`${GymAPI.baseURL}/trainer/clients?active=true`, {
                    headers: { Authorization: 'Bearer ' + token }
                });
                const data = await res.json();
                const clients = Array.isArray(data.clients) ? data.clients : [];
                document.getElementById('totalClients').textContent = clients.length;

                // Keep placeholders for other stats for now
                // TODO: replace with real endpoints when available
                document.getElementById('activePrograms').textContent = '--';
                document.getElementById('avgAdherence').textContent = '--';
            } catch (error) {
                console.error('Error loading trainer stats:', error);
                document.getElementById('totalClients').textContent = '0';
                document.getElementById('activePrograms').textContent = '--';
                document.getElementById('avgAdherence').textContent = '--';
            }
        }
        
        async function loadRecentActivities() {
            try {
                // Mock recent activities - replace with real API
                const activities = [
                    {
                        client: 'Mario Rossi',
                        action: 'Completato allenamento',
                        time: new Date(Date.now() - 2 * 60 * 60 * 1000) // 2 hours ago
                    },
                    {
                        client: 'Anna Bianchi',
                        action: 'Saltato allenamento programmato',
                        time: new Date(Date.now() - 5 * 60 * 60 * 1000) // 5 hours ago
                    }
                ];
                
                const container = document.getElementById('recentActivities');
                
                if (activities.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📝</div>
                            <h3>Nessuna attività recente</h3>
                            <p>Le attività recenti dei clienti appariranno qui.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = activities.map(activity => `
                        <div class="activity-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e9ecef;">
                            <div>
                                <strong>${activity.client}</strong> - ${activity.action}
                            </div>
                            <small style="color: #6c757d;">${Utils.getRelativeTime(activity.time)}</small>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error loading recent activities:', error);
            }
        }
        
        async function loadAttentionClients() {
            try {
                // Mock attention clients - replace with real API
                const attentionClients = [
                    // Example: clients with low adherence, missed sessions, etc.
                ];
                
                const container = document.getElementById('attentionClients');
                
                if (attentionClients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">✅</div>
                            <h3>Tutti i clienti sono in regola</h3>
                            <p>Nessun cliente richiede attenzione al momento.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = attentionClients.map(client => `
                        <div class="attention-client">
                            <div class="attention-client-info">
                                <h4>${client.name}</h4>
                                <p>${client.reason}</p>
                            </div>
                            <span class="attention-badge">${client.priority}</span>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error loading attention clients:', error);
            }
        }
        
        async function loadQuickStats() {
            try {
                // Mock quick stats - replace with real API
                const quickStats = {
                    todaySessions: 8,
                    weekStreak: 5
                };
                
                const todayEl = document.getElementById('todaySessions');
                const streakEl = document.getElementById('weekStreak');
                
                if (todayEl) todayEl.textContent = quickStats.todaySessions;
                if (streakEl) streakEl.textContent = quickStats.weekStreak;
                
            } catch (error) {
                console.error('Error loading quick stats:', error);
                const todayEl = document.getElementById('todaySessions');
                const streakEl = document.getElementById('weekStreak');
                
                if (todayEl) todayEl.textContent = '0';
                if (streakEl) streakEl.textContent = '0';
            }
        }
        
        function showDashboardError(message) {
            const dashboard = document.querySelector('.trainer-dashboard');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            dashboard.insertBefore(errorDiv, dashboard.firstChild);
        }
        
        // Modal functions
        function showNewClientModal() {
            document.getElementById('newClientModal').classList.add('show');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            
            // Clear form if it exists
            const form = document.querySelector(`#${modalId} form`);
            if (form) {
                form.reset();
                const errorDiv = form.querySelector('.error-message');
                if (errorDiv) errorDiv.style.display = 'none';
            }
        }
        
        // New client form handler
        document.getElementById('newClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const errorDiv = document.getElementById('newClientError');
            
            const formData = new FormData(e.target);
            const clientData = {
                email: formData.get('email'),
                password: Math.random().toString(36).substring(2, 10), // Generate random password
                full_name: formData.get('full_name'),
                user_type: 'standard'
            };
            
            // Additional profile data
            const profileData = {};
            if (formData.get('phone')) profileData.phone = formData.get('phone');
            if (formData.get('fitness_goal')) profileData.fitness_goal = formData.get('fitness_goal');
            if (formData.get('experience_level')) profileData.experience_level = formData.get('experience_level');
            
            errorDiv.style.display = 'none';
            Utils.showLoading(submitBtn, 'Creando cliente...');
            
            try {
                // Create user account
                const newUser = await GymAPI.post('/auth/register', clientData);
                
                // Update profile with additional data if provided
                if (Object.keys(profileData).length > 0) {
                    // Note: This would require admin API endpoints to update other users' profiles
                    console.log('Additional profile data to update:', profileData);
                }
                
                Utils.hideLoading(submitBtn);
                alert(`Cliente creato con successo!\n\nCredenziali:\nEmail: ${clientData.email}\nPassword temporanea: ${clientData.password}\n\nIl cliente dovrebbe cambiare la password al primo accesso.`);
                
                closeModal('newClientModal');
                
                // Refresh dashboard stats
                await loadTrainerStats();
                
            } catch (error) {
                Utils.hideLoading(submitBtn);
                errorDiv.textContent = error.message || 'Errore nella creazione del cliente';
                errorDiv.style.display = 'block';
                console.error('Create client error:', error);
            }
        });
        
        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                const modalId = e.target.id;
                closeModal(modalId);
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal.show');
                if (openModal) {
                    closeModal(openModal.id);
                }
            }
        });
        
        function logout() {
            const confirmLogout = confirm('Sei sicuro di voler uscire?');
            if (confirmLogout) {
                GymAPI.logout();
            }
        }
        
        // Initialize trainer dashboard
        checkTrainerAccess();
        
        // Auto-refresh data every 5 minutes
        setInterval(() => {
            if (GymAPI.isAuthenticated()) {
                loadTrainerStats();
                loadRecentActivities();
                loadAttentionClients();
                loadQuickStats();
            }
        }, 5 * 60 * 1000);
        
        // Handle tab visibility for refresh
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && GymAPI.isAuthenticated()) {
                loadTrainerStats();
                loadRecentActivities();
            }
        });
    </script>
</body>
</html>
