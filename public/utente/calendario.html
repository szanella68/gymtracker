<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymTracker - Il mio Calendario</title>
    <base href="/gymtracker/">
    <link rel="stylesheet" href="shared/css/shared.css">
    <link rel="stylesheet" href="utente/css/utente.css">
</head>
<body>
    <div data-include="shared/partials/header_user.html"></div>
    <div class="calendar-container">
        <div class="calendar-header"></div>

        <div class="card">
            <div class="card-header">
                <h1>üìÖ Il Mio Calendario Allenamenti</h1>
            </div>
            
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)" class="btn btn-blue btn-with-icon">‚óÄ Precedente</button>
                <h2 id="currentMonth" class="calendar-month">Caricamento...</h2>
                <button onclick="changeMonth(1)" class="btn btn-blue btn-with-icon">Successivo ‚ñ∂</button>
                <button onclick="goToToday()" class="btn btn-amber btn-with-icon">üìç Oggi</button>
            </div>

            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>üìã Legenda</h3>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-color" style="background: #667eea;"></span>
                    <span>Allenamento programmato</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #28a745;"></span>
                    <span>Completato</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #dc3545;"></span>
                    <span>Saltato</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ffc107;"></span>
                    <span>In corso</span>
                </div>
            </div>
        </div>

        <!-- Session Details Modal -->
        <div id="sessionModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('sessionModal')">&times;</button>
                <div id="sessionDetails">
                    <!-- Session details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="shared/js/core/api.js"></script>
    <script src="shared/js/include.js"></script>
    <script src="shared/js/core/utils.js"></script>
    <script>
        // Auth check
        if (!GymAPI.isAuthenticated()) {
            window.location.href = '/gymtracker/utente/';
        }

        let currentDate = new Date();
        let scheduledItems = [];
        const monthNames = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
        const dayNames = ["Dom","Lun","Mar","Mer","Gio","Ven","Sab"];

        async function loadScheduleForMonth() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).toISOString().slice(0,10);
            const lastDay = new Date(year, month + 1, 0).toISOString().slice(0,10);
            try {
                const data = await GymAPI.get(`/users/me/schedule?start=${firstDay}&end=${lastDay}`);
                scheduledItems = data.items || [];
                // Also load goal deadlines for the month
                try {
                    const g = await GymAPI.get('/users/me/goals');
                    const goals = (g.items || []).filter(x => x.target_date && x.status !== 'completed');
                    window._goalDeadlines = goals.filter(x => x.target_date >= firstDay && x.target_date <= lastDay);
                } catch { window._goalDeadlines = []; }
            } catch (e) {
                console.error('Load my schedule failed', e);
                scheduledItems = [];
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const startingDayOfWeek = firstDay.getDay();
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();

            let html = '';
            dayNames.forEach(d => html += `<div class="calendar-day-header">${d}</div>`);
            for (let i = 0; i < startingDayOfWeek; i++) html += '<div class="calendar-day other-month"></div>';
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(year, month, day);
                const dateStr = d.toISOString().slice(0,10);
                const isToday = d.toDateString() === today.toDateString();
                const items = scheduledItems.filter(it => it.date === dateStr);
                const anyCompleted = items.some(it => (it.status || '').toLowerCase() === 'completed');
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (items.length) classes += ' has-workout';
                if (anyCompleted) classes += ' completed';
                const goalIcons = (window._goalDeadlines || []).filter(go => go.target_date === dateStr);
                html += `
                  <div class="${classes}" onclick="showDayDetails(${year}, ${month}, ${day})">
                    <div class="day-number">${day}</div>
                    ${goalIcons.map(go => `<div class=\"workout-indicator\" style=\"background:#0ea5e9;color:#fff;\" title=\"Scadenza obiettivo\">üéØ ${Utils.escapeHtml(go.title)}</div>`).join('')}
                    ${items.map(it => {
                        const done = (it.status||'').toLowerCase()==='completed';
                        return `<div class=\"workout-indicator ${done ? 'completed' : ''}\">${(it.sessioni && it.sessioni.nome) ? it.sessioni.nome : 'Allenamento'}</div>`;
                    }).join('')}
                  </div>`;
            }
            document.getElementById('calendarGrid').innerHTML = html;
        }

        async function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            await loadScheduleForMonth();
            renderCalendar();
        }

        async function goToToday() {
            currentDate = new Date();
            await loadScheduleForMonth();
            renderCalendar();
        }

        async function showDayDetails(year, month, day) {
            const date = new Date(year, month, day);
            const dateStr = date.toISOString().slice(0,10);
            const display = date.toLocaleDateString('it-IT');
            const items = scheduledItems.filter(it => it.date === dateStr);
            const list = items.length
              ? `<ul class="exercises-list">${items.map(it => `<li style=\"display:flex; justify-content:space-between; align-items:center; gap:8px;\"><strong>${it.sessioni?.nome || 'Allenamento'}</strong><button class=\"btn btn-save btn-sm btn-with-icon\" onclick=\"startWorkout('${it.sessione_id}','${dateStr}')\">‚ñ∂ Inizia</button></li>`).join('')}</ul>`
              : '<div class="empty-state">Nessun allenamento pianificato</div>';
            document.getElementById('sessionDetails').innerHTML = `
                <h2>üìÖ ${display}</h2>
                <div class="session-info">
                    ${list}
                </div>`;
            const modal = document.getElementById('sessionModal');
            modal.classList.add('show');
            try { addModalCloseGuards(modal, () => false); } catch {}
        }

        // Modal helpers con avviso modifiche non salvate
        function addModalCloseGuards(modalEl, isDirtyFn) {
            if (!modalEl) return;
            try { modalEl._cleanup && modalEl._cleanup(); } catch {}
            function attemptClose() {
                try {
                    if (isDirtyFn && isDirtyFn()) {
                        const ok = confirm('Hai modifiche non salvate. Chiudere senza salvare?');
                        if (!ok) return;
                    }
                } catch {}
                cleanup();
                modalEl.classList.remove('show');
            }
            function onBackdrop(e){ if (e.target === modalEl) attemptClose(); }
            function onKey(e){ if (e.key === 'Escape') attemptClose(); }
            function cleanup(){
                modalEl.removeEventListener('click', onBackdrop);
                document.removeEventListener('keydown', onKey);
            }
            modalEl._attemptClose = attemptClose;
            modalEl._cleanup = cleanup;
            modalEl.addEventListener('click', onBackdrop);
            document.addEventListener('keydown', onKey);
        }
        function closeModal(modalId, force=false) {
            const el = document.getElementById(modalId);
            if (!el) return;
            if (force || !el._attemptClose) { try { el._cleanup && el._cleanup(); } catch {} el.classList.remove('show'); return; }
            el._attemptClose();
        }
        function logout() { const c = confirm('Sei sicuro di voler uscire?'); if (c) GymAPI.logout(); }
        document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target.id); });

        async function startWorkout(sessione_id, dateStr) {
            try {
                console.log('[User] startWorkout', { sessione_id, date: dateStr, url: GymAPI.baseURL + '/users/me/workouts/start' });
                const { workout } = await GymAPI.post('/users/me/workouts/start', { sessione_id, date: dateStr });
                await openWorkoutForm(workout.id);
            } catch (e) {
                console.error('[User] startWorkout error', e);
                alert('Impossibile avviare la sessione');
            }
        }

        async function openWorkoutForm(workoutLogId) {
            try {
                const data = await GymAPI.get(`/users/me/workouts/${workoutLogId}/details`);
                const logsByExercise = {};
                (data.logs || []).forEach(l => { logsByExercise[l.exercise_id] = l; });
                const prevByExercise = {};
                (data.previous_logs || []).forEach(l => { prevByExercise[l.exercise_id] = l; });
                window._prevByExercise = prevByExercise;
                const html = `
                  <h2>üèãÔ∏è Sessione</h2>
                  <div class="session-info">
                    ${data.exercises.map(ex => {
                      const log = logsByExercise[ex.id];
                      const current = Array.isArray(log?.actual_sets_data) && log.actual_sets_data.length ? log.actual_sets_data[0] : {};
                      const prev = Array.isArray(prevByExercise[ex.id]?.actual_sets_data) && prevByExercise[ex.id].actual_sets_data.length ? prevByExercise[ex.id].actual_sets_data[0] : {};
                      const defReps = (current.reps ?? prev.reps ?? '');
                      const defWeight = (current.weight ?? prev.weight ?? '');
                      return `
                        <div class=\"card\" style=\"margin-bottom:12px;\">
                          <div class=\"card-header\"><h3>${Utils.escapeHtml(ex.name)}</h3></div>
                          <div class=\"form-group inline\">
                            <label>Ripetizioni</label>
                            <input type=\"number\" id=\"rep_${ex.id}\" value=\"${defReps}\" min=\"0\" />
                          </div>
                          <div class=\"form-group inline\">
                            <label>Kg</label>
                            <input type=\"number\" step=\"0.1\" id=\"kg_${ex.id}\" value=\"${defWeight}\" />
                          </div>
                          <div class=\"form-group\">
                            <label>Note</label>
                            <textarea id=\"note_${ex.id}\">${log?.notes ? Utils.escapeHtml(log.notes) : ''}</textarea>
                          </div>
                          <div class=\"flex\" style=\"gap:8px;\">
                            <button class=\"btn btn-save btn-sm\" onclick=\"saveExerciseLog('${workoutLogId}','${ex.id}')\">üíæ Salva</button>
                          </div>
                        </div>`;
                    }).join('')}
                    <div class=\"flex\" style=\"gap:8px;\">
                      <button class=\"btn btn-blue\" onclick=\"copyPrevForAll()\">Copia valori settimana precedente</button>
                      <button class=\"btn btn-save btn-with-icon\" onclick=\"saveAllLogs('${workoutLogId}')\">üíæ Salva tutto</button>
                      <button class=\"btn btn-save btn-with-icon\" onclick=\"completeWorkout('${workoutLogId}')\">‚úÖ Completa sessione</button>
                    </div>
                  </div>`;
                document.getElementById('sessionDetails').innerHTML = html;
                // Cattura stato iniziale per guard (post-render)
                const initial = {};
                Array.from(document.querySelectorAll('[id^="rep_"]')).forEach(r => {
                    const exId = r.id.replace('rep_', '');
                    const k = document.getElementById(`kg_${exId}`);
                    const n = document.getElementById(`note_${exId}`);
                    initial[exId] = {
                        reps: String(r.value ?? ''),
                        weight: String(k?.value ?? ''),
                        notes: String(n?.value ?? '')
                    };
                });
                window._initialWorkoutInputs = initial;
                const modal2 = document.getElementById('sessionModal');
                addModalCloseGuards(modal2, function isDirtyWorkout(){
                    const init = window._initialWorkoutInputs || {};
                    const keys = Object.keys(init);
                    for (const exId of keys) {
                        const r = document.getElementById(`rep_${exId}`);
                        const k = document.getElementById(`kg_${exId}`);
                        const n = document.getElementById(`note_${exId}`);
                        const cur = {
                            reps: (r?.value ?? '').toString(),
                            weight: (k?.value ?? '').toString(),
                            notes: (n?.value ?? '').toString()
                        };
                        const ini = init[exId] || { reps:'', weight:'', notes:'' };
                        if (cur.reps !== ini.reps || cur.weight !== ini.weight || cur.notes !== ini.notes) return true;
                    }
                    return false;
                });
            } catch (e) {
                alert('Errore caricamento esercizi');
            }
        }

        async function saveExerciseLog(workoutLogId, exerciseId) {
            try {
                const reps = document.getElementById(`rep_${exerciseId}`).value;
                const weight = document.getElementById(`kg_${exerciseId}`).value;
                const notes = document.getElementById(`note_${exerciseId}`).value;
                await GymAPI.post('/users/me/exercise-logs', { workout_log_id: workoutLogId, exercise_id: exerciseId, reps, weight, notes });
                if (!window._initialWorkoutInputs) window._initialWorkoutInputs = {};
                window._initialWorkoutInputs[exerciseId] = { reps: String(reps ?? ''), weight: String(weight ?? ''), notes: String(notes ?? '') };
                alert('Salvato');
            } catch (e) { alert('Errore salvataggio'); }
        }

        async function saveAllLogs(workoutLogId) {
            try {
                // naive: read all inputs with ids rep_*, kg_*, note_*
                const inputs = Array.from(document.querySelectorAll('[id^="rep_"]'));
                for (const r of inputs) {
                    const exerciseId = r.id.replace('rep_', '');
                    const reps = r.value;
                    const weight = document.getElementById(`kg_${exerciseId}`).value;
                    const notes = document.getElementById(`note_${exerciseId}`).value;
                    await GymAPI.post('/users/me/exercise-logs', { workout_log_id: workoutLogId, exercise_id: exerciseId, reps, weight, notes });
                    if (!window._initialWorkoutInputs) window._initialWorkoutInputs = {};
                    window._initialWorkoutInputs[exerciseId] = { reps: String(reps ?? ''), weight: String(weight ?? ''), notes: String(notes ?? '') };
                }
                alert('Tutti i dati salvati');
            } catch (e) { alert('Errore salvataggio multiplo'); }
        }

        function copyPrevForAll() {
            const prev = window._prevByExercise || {};
            let count = 0;
            document.querySelectorAll('[id^="rep_\"]').forEach(repEl => {
                const exId = repEl.id.replace('rep_', '');
                const prevLog = prev[exId];
                if (prevLog && Array.isArray(prevLog.actual_sets_data) && prevLog.actual_sets_data.length) {
                    const first = prevLog.actual_sets_data[0] || {};
                    const r = document.getElementById(`rep_${exId}`);
                    const k = document.getElementById(`kg_${exId}`);
                    if (r) r.value = (first.reps ?? '');
                    if (k) k.value = (first.weight ?? '');
                    count++;
                }
            });
            alert(count ? 'Valori copiati dalla settimana precedente' : 'Nessun dato precedente disponibile');
        }

        async function completeWorkout(workoutLogId) {
            try {
                await GymAPI.post('/users/me/workouts/complete', { workout_log_id: workoutLogId });
                alert('Sessione completata');
                closeModal('sessionModal', true);
                await loadScheduleForMonth();
                renderCalendar();
            } catch (e) { alert('Errore completamento sessione'); }
        }

        (async function init() {
            await loadScheduleForMonth();
            renderCalendar();
        })();

        // Add styles for new components
        const style = document.createElement('style');
        style.textContent = `
            .nav-breadcrumb {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 20px;
            }
            
            .breadcrumb-link {
                color: #667eea;
                text-decoration: none;
                font-weight: 500;
            }
            
            .breadcrumb-link:hover {
                text-decoration: underline;
            }
            
            .breadcrumb-separator {
                color: #6c757d;
                font-weight: bold;
            }
            
            .breadcrumb-current {
                color: #333;
                font-weight: 600;
            }
            
            .calendar-controls {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            
            .legend {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .legend-item {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .legend-color {
                width: 16px;
                height: 16px;
                border-radius: 3px;
            }
            
            .session-info .exercises-list {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 6px;
                margin: 10px 0;
            }
            
            .session-info .exercises-list li {
                margin-bottom: 8px;
            }
            /* Inline form rows in workout modal */
            .session-info .form-group { display:flex; align-items:center; gap:12px; }
            .session-info .form-group label { margin:0; min-width:140px; }
            .session-info .form-group input,
            .session-info .form-group select,
            .session-info .form-group textarea { flex:1; width:auto; }
            @media (max-width: 520px) {
              .session-info .form-group { flex-direction: column; align-items: stretch; }
              .session-info .form-group label { min-width: 0; margin-bottom: 6px; }
              .session-info .form-group input,
              .session-info .form-group select,
              .session-info .form-group textarea { width: 100%; }
            }
            /* Completed styling */
            .calendar-day.completed { border-color: #28a745; }
            .workout-indicator.completed { background: #28a745; color: #fff; }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
