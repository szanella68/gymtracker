<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymTracker - I miei Progressi</title>
    <base href="/gymtracker/">
    <link rel="stylesheet" href="shared/css/shared.css">
    <link rel="stylesheet" href="utente/css/utente.css">
</head>
<body>
    <div data-include="shared/partials/header_user.html"></div>
    <div class="profile-container">
          <div class="profile-header">
            <h1>üìä I miei Progressi</h1>
            <div class="header-actions">
                <button onclick="exportData()" class="btn-secondary">üì• Esporta Dati</button>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="stats-grid">
            <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                <div class="stat-icon">üéØ</div>
                <div class="stat-info">
                    <h3 id="goalProgress">78%</h3>
                    <p>Obiettivo mensile</p>
                </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%); color: white;">
                <div class="stat-icon">üî•</div>
                <div class="stat-info">
                    <h3 id="currentStreak">12</h3>
                    <p>Serie attuale (giorni)</p>
                </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white;">
                <div class="stat-icon">‚ö°</div>
                <div class="stat-info">
                    <h3 id="totalWorkouts">156</h3>
                    <p>Allenamenti totali</p>
                </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #e83e8c 0%, #6f42c1 100%); color: white;">
                <div class="stat-icon">üìà</div>
                <div class="stat-info">
                    <h3 id="improvement">+15%</h3>
                    <p>Miglioramento forza</p>
                </div>
            </div>
        </div>

        <!-- Progress Charts Section -->
        <div class="card">
            <div class="card-header">
                <h3>üìà Andamento nel Tempo</h3>
                <div class="chart-controls">
                    <select id="chartPeriod" onchange="updateChart()">
                        <option value="7">Ultimi 7 giorni</option>
                        <option value="30" selected>Ultimi 30 giorni</option>
                        <option value="90">Ultimi 3 mesi</option>
                        <option value="365">Ultimo anno</option>
                    </select>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="mock-chart">
                    <div class="chart-placeholder">
                        <div class="chart-icon">üìä</div>
                        <h4>Grafico Aderenza Allenamenti</h4>
                        <p>Aderenza settimanale nel periodo selezionato</p>
                        <div class="mock-chart-bars"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Completed Workouts -->
        <div class="card">
            <div class="card-header">
                <h3>üèÅ Allenamenti Completati (recenti)</h3>
            </div>
            <div id="recentCompleted" class="weight-history"></div>
        </div>

        <!-- Strength Progress (dynamic) -->
        <div class="card">
            <div class="card-header">
                <h3>üí™ Progressi di Forza</h3>
            </div>
            <div id="strengthProgress" class="strength-progress"></div>
        </div>

        <!-- Recent Exercises Summary -->
        <div class="card">
            <div class="card-header">
                <h3>üí™ Esercizi Recenti</h3>
            </div>
            <div id="recentExercises" class="weight-history"></div>
        </div>

        <!-- Add Weight Modal -->
        <div id="weightModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('weightModal')">&times;</button>
                <h2>‚öñÔ∏è Nuova Misurazione</h2>
                <form id="weightForm">
                    <div class="form-group">
                        <label for="weightDate">Data</label>
                        <input type="date" id="weightDate" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="weightValue">Peso (kg)</label>
                        <input type="number" id="weightValue" name="weight" step="0.1" min="30" max="200" required>
                    </div>
                    <div class="form-group">
                        <label for="weightNotes">Note (opzionale)</label>
                        <textarea id="weightNotes" name="notes" rows="3" placeholder="Es: Dopo allenamento, mattino a digiuno..."></textarea>
                    </div>
                    <button type="submit" class="btn-primary w-full">Salva Misurazione</button>
                </form>
            </div>
        </div>
    </div>

    <script src="shared/js/core/api.js"></script>
    <script src="shared/js/include.js"></script>
    <script src="shared/js/core/utils.js"></script>
    <script>
        // Auth check
        if (!GymAPI.isAuthenticated()) {
            window.location.href = '/gymtracker/utente/';
        }

        async function updateChart() {
            const period = parseInt(document.getElementById('chartPeriod').value, 10);
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - (period - 1));
            const fmt = d => d.toISOString().slice(0,10);
            // Fetch workouts in period
            let items = [];
            try {
                const data = await GymAPI.get(`/users/me/schedule?start=${fmt(start)}&end=${fmt(end)}`);
                items = data.items || [];
            } catch (e) { console.warn('Chart load failed', e); }
            // Group by ISO week (Mon-Sun)
            const weekKey = (d) => {
                const x = new Date(d);
                // Monday as first day
                const day = x.getDay();
                const diff = (day === 0 ? -6 : 1) - day;
                x.setDate(x.getDate() + diff);
                return x.toISOString().slice(0,10);
            };
            const buckets = new Map();
            for (const it of items) {
                const k = weekKey(it.date);
                const b = buckets.get(k) || { total: 0, completed: 0 };
                b.total += 1;
                if ((it.status||'').toLowerCase() === 'completed') b.completed += 1;
                buckets.set(k, b);
            }
            const series = Array.from(buckets.entries()).sort((a,b)=> a[0].localeCompare(b[0]))
                               .map(([k, b]) => ({ label: k, value: b.total ? Math.round((b.completed/b.total)*100) : 0 }));
            // Render simple bars
            const container = document.querySelector('.mock-chart-bars');
            if (container) {
                container.innerHTML = series.length ? series.map(s => `<div class="chart-bar" style="height:${Math.max(5, Math.min(100, s.value))}%;" title="${s.label}: ${s.value}%"></div>`).join('') : '<div style="color:#6c757d;">Nessun dato nel periodo</div>';
            }
        }

        function addWeightEntry() {
            // Set today's date as default
            document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('weightModal').classList.add('show');
        }

        async function loadStats() {
            try {
                const s = await GymAPI.get('/users/me/stats');
                document.getElementById('goalProgress').textContent = (s.adherence_rate ?? 0) + '%';
                document.getElementById('currentStreak').textContent = s.upcoming_sessions ?? 0; // reuse tile for upcoming
                document.getElementById('totalWorkouts').textContent = s.completed_workouts ?? 0;
                document.getElementById('improvement').textContent = `${s.completed_this_month ?? 0}/${s.total_sessions_this_month ?? 0}`;
            } catch (e) {
                console.warn('loadStats failed', e);
            }
        }

        async function loadRecent() {
            try {
                const data = await GymAPI.get('/users/me/recent');
                const rc = document.getElementById('recentCompleted');
                if (!data.recent_completed || data.recent_completed.length === 0) {
                    rc.innerHTML = '<div class="empty-state">Nessun allenamento completato di recente</div>';
                } else {
                    rc.innerHTML = data.recent_completed.map(w => `
                        <div class="weight-entry">
                            <span class="weight-date">${Utils.formatDate(w.completed_at || w.workout_date)}</span>
                            <span class="weight-value">${w.sessioni?.nome || 'Allenamento'}</span>
                            <span class="weight-change down">Completato</span>
                        </div>
                    `).join('');
                }

                const re = document.getElementById('recentExercises');
                if (!data.recent_exercises || data.recent_exercises.length === 0) {
                    re.innerHTML = '<div class="empty-state">Nessun esercizio recente</div>';
                } else {
                    re.innerHTML = data.recent_exercises.map(e => `
                        <div class="weight-entry">
                            <span class="weight-date">${Utils.formatDate(e.date)}</span>
                            <span class="weight-value">${Utils.escapeHtml(e.name)}${e.reps?` ‚Äî ${e.reps} reps`:''}${(e.weight||e.weight===0)?` @ ${e.weight}kg`:''}</span>
                            <span class="weight-change ${e.volume? 'down':''}">${e.volume? (e.volume.toFixed? e.volume.toFixed(1) : e.volume) + ' vol' : ''}</span>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.warn('loadRecent failed', e);
            }
        }

        function exportData() {
            // Mock export functionality
            const data = {
                user: "Cliente",
                period: "Ultimi 6 mesi",
                workouts: 156,
                adherence: "78%",
                weight_change: "-1.7kg",
                strength_improvements: {
                    bench_press: "+33%",
                    squat: "+43%",
                    deadlift: "+50%"
                },
                export_date: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `gymtracker-progress-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function logout() {
            const confirmLogout = confirm('Sei sicuro di voler uscire?');
            if (confirmLogout) {
                GymAPI.logout();
            }
        }

        // Weight form mock removed

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        (async function init() {
            await loadStats();
            await updateChart();
            await loadRecent();
            await loadStrengthProgress();
        })();

        async function loadStrengthProgress() {
            const box = document.getElementById('strengthProgress');
            box.innerHTML = 'Caricamento...';
            try {
                const { items } = await GymAPI.get('/users/me/exercises/active-history?days=120&upcoming_days=45');
                if (!items || !items.length) {
                    box.innerHTML = '<div class="empty-state">Nessun esercizio attivo trovato nelle prossime settimane</div>';
                    return;
                }
                box.innerHTML = items.map(it => renderStrengthItem(it)).join('');
            } catch (e) {
                box.innerHTML = '<div class="error-message">Errore caricamento progressi di forza</div>';
            }
        }

        function renderStrengthItem(it){
            const series = Array.isArray(it.series) ? it.series.filter(p => typeof p.weight === 'number' || typeof p.reps === 'number') : [];
            if (!series.length) return '';
            const firstW = series.find(p => typeof p.weight === 'number')?.weight ?? null;
            const last = it.latest || series[series.length-1];
            const lastW = typeof last.weight === 'number' ? last.weight : null;
            const pr = it.pr_weight ?? lastW ?? firstW ?? 0;
            const pct = pr ? Math.max(0, Math.min(100, Math.round(((lastW || 0) / pr) * 100))) : 0;
            const deltaPct = (firstW && lastW) ? Math.round(((lastW - firstW) / firstW) * 100) : 0;
            const svg = buildDualSparkline(series);
            return `
              <div class="exercise-progress">
                <div class="exercise-header">
                  <h4>${Utils.escapeHtml(it.name)}</h4>
                  <span class="pr-badge">PR: ${pr ? pr + 'kg' : '‚Äî'}</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                <div class="progress-details">
                  <span>Partenza: ${firstW != null ? firstW+'kg' : '‚Äî'}</span>
                  <span>Attuale: ${lastW != null ? lastW+'kg' : '‚Äî'} ${firstW && lastW ? `(${deltaPct>0?'+':''}${deltaPct}%)` : ''}</span>
                </div>
                <div class="mini-chart">${svg}</div>
              </div>`;
        }

        function buildDualSparkline(series){
            // Prepare normalized points for weight and reps
            const pts = series.map(s => ({
                w: typeof s.weight === 'number' ? s.weight : null,
                r: typeof s.reps === 'number' ? s.reps : null
            }));
            const wVals = pts.map(p=>p.w).filter(v=>v!=null);
            const rVals = pts.map(p=>p.r).filter(v=>v!=null);
            const W = 240, H = 60, P=6;
            const n = series.length;
            const x = i => P + (i*(W-2*P))/Math.max(1,(n-1));
            const scale = (val, min, max) => {
                if (min===max) return H/2;
                return H - P - ((val - min) / (max - min)) * (H - 2*P);
            };
            let wPath = '', rPath='';
            if (wVals.length) {
                const wMin = Math.min(...wVals), wMax = Math.max(...wVals);
                wPath = pts.map((p,i)=> p.w==null?null:`${i===0?'M':'L'}${x(i)},${scale(p.w,wMin,wMax)}`).filter(Boolean).join(' ');
            }
            if (rVals.length) {
                const rMin = Math.min(...rVals), rMax = Math.max(...rVals);
                rPath = pts.map((p,i)=> p.r==null?null:`${i===0?'M':'L'}${x(i)},${scale(p.r,rMin,rMax)}`).filter(Boolean).join(' ');
            }
            return `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
                <rect x="0" y="0" width="${W}" height="${H}" rx="6" fill="#fff" stroke="#e9ecef" />
                ${wPath ? `<path d="${wPath}" fill="none" stroke="#10b981" stroke-width="2" />` : ''}
                ${rPath ? `<path d="${rPath}" fill="none" stroke="#6366f1" stroke-width="2" />` : ''}
                <g font-size="10" fill="#6c757d">
                  <text x="8" y="12">kg</text>
                  <text x="28" y="12" fill="#6366f1">reps</text>
                </g>
              </svg>`;
        }

        // Add styles for new components
        const style = document.createElement('style');
        style.textContent = `
            .header-actions {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }
            
            .chart-controls {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            
            .mock-chart {
                padding: 40px 20px;
                text-align: center;
                background: #f8f9fa;
                border-radius: 8px;
                margin: 20px 0;
            }
            
            .chart-icon {
                font-size: 3rem;
                margin-bottom: 15px;
            }
            
            .mock-chart-bars {
                display: flex;
                justify-content: center;
                align-items: end;
                gap: 10px;
                margin-top: 20px;
                height: 100px;
            }
            
            .chart-bar {
                width: 30px;
                background: linear-gradient(to top, #667eea, #764ba2);
                border-radius: 3px 3px 0 0;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            
            .chart-bar:hover {
                opacity: 0.8;
            }
            
            .weight-history {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .weight-entry {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                border-bottom: 1px solid #e9ecef;
            }
            
            .weight-change.down {
                color: #28a745;
                font-weight: 600;
            }
            
            .weight-change.up {
                color: #dc3545;
                font-weight: 600;
            }
            
            .weight-change.start {
                color: #6c757d;
                font-style: italic;
            }
            
            .exercise-progress {
                margin-bottom: 25px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 8px;
            }
            
            .exercise-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            
            .pr-badge {
                background: #ffc107;
                color: #000;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
            }
            
            .progress-bar {
                width: 100%;
                height: 8px;
                background: #e9ecef;
                border-radius: 4px;
                overflow: hidden;
                margin: 10px 0;
            }
            
            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #28a745, #20c997);
                transition: width 0.3s ease;
            }
            
            .progress-details {
                display: flex;
                justify-content: space-between;
                font-size: 14px;
                color: #6c757d;
            }
            
            .goals-list {
                max-height: 400px;
                overflow-y: auto;
            }
            
            .goal-item {
                display: flex;
                gap: 15px;
                padding: 20px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                margin-bottom: 15px;
                transition: border-color 0.2s;
            }
            
            .goal-item.completed {
                border-color: #28a745;
                background: #f8fff8;
            }
            
            .goal-item.in-progress {
                border-color: #ffc107;
                background: #fffef8;
            }
            
            .goal-item.pending {
                border-color: #6c757d;
                background: #f8f9fa;
            }
            
            .goal-icon {
                font-size: 1.5rem;
                margin-top: 5px;
            }
            
            .goal-info {
                flex-grow: 1;
            }
            
            .goal-info h4 {
                margin-bottom: 5px;
            }
            
            .goal-info p {
                color: #6c757d;
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            @media (max-width: 768px) {
                .header-actions {
                    width: 100%;
                    justify-content: center;
                }
                
                .chart-controls {
                    width: 100%;
                    justify-content: center;
                }
                
                .weight-entry {
                    flex-direction: column;
                    align-items: start;
                    gap: 5px;
                }
                
                .exercise-header {
                    flex-direction: column;
                    align-items: start;
                    gap: 5px;
                }
                
                .progress-details {
                    flex-direction: column;
                    gap: 5px;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
