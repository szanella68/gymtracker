<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymTracker - Il mio Dashboard</title>
    <base href="/gymtracker/">
    <link rel="stylesheet" href="shared/css/shared.css">
    <link rel="stylesheet" href="trainer/css/trainer.css">
    <link rel="stylesheet" href="utente/css/utente.css">
</head>
<script>
// Funzione per abilitare menu admin se necessario
async function enableAdminMenuIfNeeded() {
  try {
    console.log('[Dashboard] Checking admin status...');
    
    if (!window.GymAPI || !GymAPI.isAuthenticated()) {
      console.log('[Dashboard] Not authenticated');
      return;
    }

    const userProfile = await GymAPI.getCurrentUser();
    const userType = userProfile.profile?.user_type || userProfile.user_type || 'standard';
    const isAdmin = userType.toString().toLowerCase() === 'admin';
    
    console.log('[Dashboard] User type:', userType, 'isAdmin:', isAdmin);

    if (isAdmin) {
      const adminSection = document.getElementById('adminMenuSection');
      if (adminSection) {
        adminSection.style.display = 'block';
        console.log('[Dashboard] ‚úÖ Menu admin abilitato!');
      }
    }

  } catch (error) {
    console.error('[Dashboard] Errore controllo admin:', error);
  }
}

// Esegui dopo che tutto √® caricato
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(enableAdminMenuIfNeeded, 1000);
});
</script>
<body>
    <div data-include="shared/partials/header_user.html"></div>
    <main class="trainer-dashboard layout-fluid">
        <div class="dashboard-header">
            <h1>üèãÔ∏è Dashboard Utente</h1>
            <div class="trainer-actions">
                <span id="userWelcome">Benvenuto!</span>
            </div>
        </div>

        <!-- User Stats -->
        <div class="trainer-stats stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí™</div>
                <div class="stat-info">
                    <h3 id="completedWorkouts">--</h3>
                    <p>Sessioni completate</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèÉ</div>
                <div class="stat-info">
                    <h3 id="adherenceRate">--</h3>
                    <p>Aderenza media</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-info">
                    <h3 id="progressTrend">--</h3>
                    <p>Giorni di streak</p>
                </div>
            </div>
        </div>

        <!-- Navigazione principale -->
        <div class="trainer-nav nav-menu">
            <a href="utente/calendario.html" class="nav-card primary">
                <div class="nav-icon">üìÖ</div>
                <h3>Il Mio Calendario</h3>
                <p>Visualizza allenamenti programmati</p>
            </a>
            
            <a href="utente/schede.html" class="nav-card">
                <div class="nav-icon">üìã</div>
                <h3>I Miei Programmi</h3>
                <p>Programmi di allenamento attivi</p>
            </a>
            
            <a href="utente/goals.html" class="nav-card">
                <div class="nav-icon">üéØ</div>
                <h3>I Miei Obiettivi</h3>
                <p>Traccia progressi e obiettivi</p>
            </a>
            
            <a href="utente/report.html" class="nav-card">
                <div class="nav-icon">üìä</div>
                <h3>Report & Analytics</h3>
                <p>Statistiche e performance</p>
            </a>
        </div>
        
        <!-- Prossimi Allenamenti -->
        <div class="card">
            <div class="card-header">
                <h3>üéØ Prossimi Allenamenti</h3>
            </div>
            <div id="upcomingSessions">
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <h3>Nessun allenamento programmato</h3>
                    <p>I tuoi prossimi allenamenti appariranno qui quando il trainer li assegner√†.</p>
                </div>
            </div>
        </div>

        <!-- Attivit√† recenti -->
        <div class="card">
            <div class="card-header">
                <h3>üìã Attivit√† Recenti</h3>
            </div>
            <div id="recentActivities"></div>
        </div>

        <!-- Profilo e Obiettivi (come il link "Profilo" del trainer) -->
        <div class="card">
            <div class="card-header">
                <h3>üë§ Il Mio Profilo</h3>
            </div>
            <div class="nav-menu">
                <div class="nav-card" onclick="window.location.href='/gymtracker/utente/profilo.html'">
                    <div class="nav-icon">üë§</div>
                    <h3>Aggiorna Obiettivi</h3>
                    <p>Modifica i tuoi obiettivi fitness</p>
                </div>
                
                <div class="nav-card" onclick="contactTrainer()">
                    <div class="nav-icon">üí¨</div>
                    <h3>Contatta Trainer</h3>
                    <p>Richiedi supporto o informazioni</p>
                </div>
            </div>
        </div>
    </main>

    <script src="shared/js/core/api.js"></script>
    <script src="shared/js/include.js"></script>
    <script src="shared/js/core/utils.js"></script>
    <script>
        // Auth check
        if (!GymAPI.isAuthenticated()) {
            window.location.href = '/gymtracker/utente/';
        }
        
        // Load user dashboard data
        async function loadDashboard() {
            try {
                // Load user profile
                const userProfile = await GymAPI.getCurrentUser();
                document.getElementById('userWelcome').textContent = 
                    `Ciao, ${userProfile.profile?.full_name || 'Atleta'}!`;
                
                // Check if user is actually admin trying to access client interface
                if (userProfile.profile?.user_type === 'admin') {
                    const switchToAdmin = confirm('Sei un amministratore. Vuoi passare all\'interfaccia trainer?');
                    if (switchToAdmin) {
                        window.location.href = '/gymtracker/trainer/dashboard.html';
                        return;
                    }
                }
                
                // Load stats and upcoming sessions
                await Promise.all([
                    loadStats(),
                    loadUpcomingSessions()
                ]);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                if (error.status === 401) {
                    GymAPI.removeToken();
                    window.location.href = '/gymtracker/utente/';
                } else {
                    showDashboardError('Errore nel caricamento dei dati. Riprova pi√π tardi.');
                }
            }
        }
        
        async function loadStats() {
            try {
                const stats = await GymAPI.getUserStats();
                
                // Update stat cards
                document.getElementById('adherenceRate').textContent = stats.adherence_rate + '%';
                document.getElementById('completedWorkouts').textContent = stats.completed_workouts;
                
                // Calculate progress trend
                let trendText = 'üìà Positiva';
                if (stats.adherence_rate < 50) {
                    trendText = 'üìâ Da migliorare';
                } else if (stats.adherence_rate < 80) {
                    trendText = 'üìä Stabile';
                }
                document.getElementById('progressTrend').textContent = trendText;
                
            } catch (error) {
                console.error('Error loading stats:', error);
                // Show default values instead of failing
                document.getElementById('adherenceRate').textContent = '0%';
                document.getElementById('completedWorkouts').textContent = '0';
                document.getElementById('progressTrend').textContent = 'üìä Inizia ora';
            }
        }
        
        async function loadUpcomingSessions() {
            try {
                const sessionsContainer = document.getElementById('upcomingSessions');
                const today = new Date();
                const end = new Date(); end.setDate(end.getDate() + 21); // prossime 3 settimane
                const fmt = d => d.toISOString().slice(0,10);

                const data = await GymAPI.get(`/users/me/schedule?start=${fmt(today)}&end=${fmt(end)}`);
                let items = (data.items || []).filter(it => (it.status || 'planned') !== 'completed');
                // sort by date asc
                items.sort((a,b) => a.date.localeCompare(b.date));
                if (items.length === 0) {
                    sessionsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìÖ</div>
                            <h3>Nessun allenamento imminente</h3>
                            <p>Controlla il tuo calendario per vedere tutte le pianificazioni.</p>
                    <button class="btn btn-blue btn-with-icon" onclick="window.location.href='/gymtracker/utente/calendario.html'">üìÖ Visualizza Calendario</button>
                        </div>`;
                    return;
                }
                sessionsContainer.innerHTML = items.slice(0,8).map(it => `
                    <div class="session-item" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #e9ecef;">
                        <div class="session-info">
                            <h4 style="margin:0;">${Utils.escapeHtml(it.sessioni?.nome || 'Allenamento')}</h4>
                            <p style="margin:4px 0 0; color:#6c757d;">${Utils.formatDate(it.date)}</p>
                        </div>
                        <span class="session-status ${it.status || 'planned'}" style="font-size:12px; padding:4px 8px; border-radius:12px; border:1px solid #e9ecef;">${(it.status || 'planned')}</span>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading upcoming sessions:', error);
                document.getElementById('upcomingSessions').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <h3>Errore nel caricamento</h3>
                        <p>Impossibile caricare i prossimi allenamenti.</p>
                    <button class="btn btn-blue" onclick="loadUpcomingSessions()">Riprova</button>
                    </div>
                `;
            }
        }
        
        function showDashboardError(message) {
            const dashboard = document.querySelector('.user-dashboard');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            dashboard.insertBefore(errorDiv, dashboard.firstChild);
        }
        
        function contactTrainer() {
            // This would typically open a messaging system or contact form
            alert('Funzionalit√† in sviluppo. Per ora contatta il trainer direttamente.');
        }
        
        function logout() {
            const confirmLogout = confirm('Sei sicuro di voler uscire?');
            if (confirmLogout) {
                GymAPI.logout();
            }
        }
        
        // Initialize dashboard
        loadDashboard();
        
        // Refresh data every 5 minutes
        setInterval(() => {
            loadStats();
            loadUpcomingSessions();
        }, 5 * 60 * 1000);
        
        // Handle visibility change to refresh when user comes back to tab
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && GymAPI.isAuthenticated()) {
                loadStats();
                loadUpcomingSessions();
            }
        });
    </script>
</body>
</html>
